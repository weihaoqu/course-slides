<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turing Machines - CS305 Formal Language Theory</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
.slide { display: none; min-height: 100vh; padding: 40px 60px; position: relative; }
.slide.active { display: flex; flex-direction: column; justify-content: center; }
.slide-number { position: absolute; bottom: 20px; right: 40px; color: #64748b; font-size: 14px; }
.nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 100; }
.nav button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
.nav button:hover { background: #475569; }
.nav button:disabled { opacity: 0.3; cursor: not-allowed; }
.progress { position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.3s; z-index: 100; }
h1 { font-size: 2.8em; margin-bottom: 20px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; }
h2 { font-size: 2em; margin-bottom: 16px; color: #93c5fd; }
h3 { font-size: 1.4em; margin-bottom: 12px; color: #a5b4fc; }
p, li { font-size: 1.15em; line-height: 1.7; color: #cbd5e1; margin-bottom: 10px; }
.subtitle { font-size: 1.3em; color: #94a3b8; margin-bottom: 30px; }
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: start; }
.center { text-align: center; }
.mt { margin-top: 20px; }
.diagram { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 1em; line-height: 1.6; white-space: pre; overflow-x: auto; margin: 16px 0; color: #a5f3fc; }
.diagram.small { font-size: 0.85em; }
.key-idea { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15)); border-left: 4px solid #3b82f6; border-radius: 0 12px 12px 0; padding: 20px 24px; margin: 16px 0; }
.key-idea h3 { margin-bottom: 8px; }
.warning { background: rgba(245,158,11,0.12); border-left: 4px solid #f59e0b; border-radius: 0 12px 12px 0; padding: 20px 24px; margin: 16px 0; }
.warning h3 { color: #fbbf24; }
.analogy { background: rgba(16,185,129,0.12); border-left: 4px solid #10b981; border-radius: 0 12px 12px 0; padding: 20px 24px; margin: 16px 0; }
.analogy h3 { color: #34d399; }
table { border-collapse: collapse; margin: 16px 0; width: auto; }
th, td { border: 1px solid #475569; padding: 10px 16px; text-align: center; }
th { background: #334155; color: #93c5fd; font-weight: 600; }
td { background: #1e293b; color: #e2e8f0; }
tr.highlight td { background: rgba(59,130,246,0.2); }
.fade-in { animation: fadeIn 0.5s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
ul { padding-left: 24px; }
ul li { margin-bottom: 8px; }

/* Enhancement 1: Animated TM Machine SVG */
.tm_mach-controls { display: flex; gap: 10px; justify-content: center; margin-top: 12px; }
.tm_mach-controls button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 6px 18px; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: all 0.2s; }
.tm_mach-controls button:hover { background: #475569; }
.tm_mach-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
.tm_mach-status { text-align: center; margin-top: 8px; font-size: 0.95em; color: #94a3b8; min-height: 1.5em; }

/* Enhancement 2: TM Simulator */
.tm_sim-container { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-top: 10px; }
.tm_sim-input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
.tm_sim-input-row input { background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 6px 12px; border-radius: 6px; font-size: 1em; font-family: monospace; width: 160px; }
.tm_sim-input-row button, .tm_sim-controls button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
.tm_sim-input-row button:hover, .tm_sim-controls button:hover { background: #475569; }
.tm_sim-input-row button:disabled, .tm_sim-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
.tm_sim-controls { display: flex; gap: 10px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
.tm_sim-controls input[type="range"] { width: 100px; }
.tm_sim-state { display: inline-block; padding: 4px 14px; border-radius: 6px; font-weight: bold; font-size: 1.1em; margin: 0 8px; }
.tm_sim-log { max-height: 150px; overflow-y: auto; background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 0.82em; line-height: 1.5; color: #94a3b8; margin-top: 10px; }
.tm_sim-verdict { text-align: center; font-size: 1.1em; font-weight: bold; margin-top: 8px; min-height: 1.5em; }

/* Enhancement 3: Binary Increment */
.tm_inc-container { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; }
.tm_inc-input-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
.tm_inc-input-row input { background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 5px 10px; border-radius: 6px; font-size: 0.95em; font-family: monospace; width: 120px; }
.tm_inc-input-row button, .tm_inc-controls button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 5px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
.tm_inc-input-row button:hover, .tm_inc-controls button:hover { background: #475569; }
.tm_inc-input-row button:disabled, .tm_inc-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
.tm_inc-controls { display: flex; gap: 8px; align-items: center; margin: 8px 0; flex-wrap: wrap; }
.tm_inc-result { text-align: center; font-size: 0.95em; margin-top: 8px; min-height: 1.5em; color: #94a3b8; }

/* Enhancement 4: Transition Explorer */
.tm_trx-panel { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-top: 16px; }
.tm_trx-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
.tm_trx-buttons button { background: #0f172a; border: 1px solid #475569; color: #a5f3fc; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-family: monospace; font-size: 0.88em; transition: all 0.2s; }
.tm_trx-buttons button:hover { background: #334155; border-color: #93c5fd; }
.tm_trx-buttons button.active { border-color: #93c5fd; background: rgba(59,130,246,0.2); }
.tm_trx-narration { text-align: center; font-size: 0.95em; color: #94a3b8; min-height: 1.5em; margin-top: 8px; }

/* Enhancement 5: Quiz */
.tm_q1-container { max-width: 700px; margin: 0 auto; }
.tm_q1-question { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 16px; }
.tm_q1-question h3 { color: #93c5fd; margin-bottom: 16px; font-size: 1.15em; }
.tm_q1-options { display: flex; flex-direction: column; gap: 10px; }
.tm_q1-options button { background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 1em; text-align: left; transition: all 0.2s; }
.tm_q1-options button:hover { border-color: #93c5fd; background: rgba(59,130,246,0.1); }
.tm_q1-options button.correct { background: rgba(16,185,129,0.25); border-color: #10b981; color: #34d399; }
.tm_q1-options button.wrong { background: rgba(239,68,68,0.25); border-color: #ef4444; color: #f87171; }
.tm_q1-options button:disabled { cursor: default; opacity: 0.85; }
.tm_q1-explanation { margin-top: 12px; padding: 12px 16px; background: rgba(59,130,246,0.1); border-radius: 8px; font-size: 0.95em; color: #94a3b8; display: none; }
.tm_q1-score { text-align: center; font-size: 1.3em; margin: 20px 0; }
.tm_q1-progress { text-align: center; color: #64748b; margin-bottom: 12px; font-size: 0.95em; }
.tm_q1-retry { display: none; margin: 16px auto; background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 10px 28px; border-radius: 8px; cursor: pointer; font-size: 1.05em; }
.tm_q1-retry:hover { background: #475569; }

@keyframes tm_flash_cyan { 0% { fill: #67e8f9; } 100% { fill: #e2e8f0; } }
@keyframes tm_flash_purple { 0% { fill: #c4b5fd; } 100% { fill: #e2e8f0; } }
@keyframes tm_flash_green { 0% { fill: #10b981; } 100% { fill: #e2e8f0; } }
@keyframes tm_flash_red { 0% { fill: #ef4444; } 100% { fill: #e2e8f0; } }

/* Enhancement: PDA Failure Demo (slide 3) */
.tm_pda-panel { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; }
.tm_pda-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
.tm_pda-buttons button { background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
.tm_pda-buttons button:hover { background: #334155; border-color: #93c5fd; }
.tm_pda-buttons button.active { border-color: #f59e0b; background: rgba(245,158,11,0.15); }
.tm_pda-stack { display: flex; flex-direction: column-reverse; align-items: center; min-height: 140px; }
.tm_pda-cell { width: 48px; height: 32px; border: 1px solid #475569; background: #0f172a; display: flex; align-items: center; justify-content: center; font-family: monospace; font-size: 1.1em; color: #e2e8f0; transition: all 0.3s; border-radius: 4px; margin: 1px 0; }
.tm_pda-cell.push { background: rgba(16,185,129,0.2); border-color: #10b981; color: #34d399; }
.tm_pda-cell.pop { background: rgba(139,92,246,0.2); border-color: #8b5cf6; color: #c4b5fd; }
.tm_pda-cell.fail { background: rgba(239,68,68,0.2); border-color: #ef4444; color: #f87171; }
.tm_pda-input-tape { display: flex; gap: 2px; margin-bottom: 8px; justify-content: center; }
.tm_pda-input-cell { width: 32px; height: 28px; border: 1px solid #475569; background: #0f172a; display: flex; align-items: center; justify-content: center; font-family: monospace; font-size: 0.9em; color: #94a3b8; border-radius: 3px; transition: all 0.3s; }
.tm_pda-input-cell.reading { border-color: #fbbf24; background: rgba(251,191,36,0.15); color: #fbbf24; }
.tm_pda-input-cell.done { color: #475569; }
.tm_pda-msg { text-align: center; font-size: 0.9em; color: #94a3b8; min-height: 2.5em; margin-top: 8px; line-height: 1.4; }

/* Enhancement: PDA vs TM Comparison (slide 6) */
.tm_cmp-panel { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; }
.tm_cmp-btn { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 8px 18px; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: all 0.2s; display: block; margin: 0 auto 12px auto; }
.tm_cmp-btn:hover { background: #475569; }
.tm_cmp-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.tm_cmp-sides { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.tm_cmp-side { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 10px; text-align: center; }
.tm_cmp-side h4 { margin-bottom: 6px; font-size: 0.95em; }
.tm_cmp-side.fail { border-color: #ef4444; }
.tm_cmp-side.pass { border-color: #10b981; }
.tm_cmp-step { text-align: center; font-size: 0.85em; color: #64748b; margin-top: 6px; }

/* Enhancement: ID Transition Explorer (slide 9) */
.tm_id-panel { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-top: 16px; }
.tm_id-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.tm_id-buttons button { background: #0f172a; border: 1px solid #475569; color: #a5f3fc; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-family: monospace; font-size: 0.82em; transition: all 0.2s; }
.tm_id-buttons button:hover { background: #334155; border-color: #93c5fd; }
.tm_id-buttons button.active { border-color: #93c5fd; background: rgba(59,130,246,0.2); }
.tm_id-text { text-align: center; font-family: monospace; font-size: 1.05em; color: #e2e8f0; margin-top: 8px; min-height: 1.5em; }
.tm_id-text .changed { color: #f59e0b; font-weight: bold; }

/* Enhancement: Multi-Tape TM (slide 14) */
.tm_mt-controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
.tm_mt-controls button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 6px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
.tm_mt-controls button:hover { background: #475569; }
.tm_mt-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
.tm_mt-status { text-align: center; font-size: 0.9em; color: #94a3b8; margin-top: 6px; min-height: 1.5em; }

/* Enhancement: NTM Branching Tree (slide 15) */
.tm_ntm-controls { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
.tm_ntm-controls button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 6px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
.tm_ntm-controls button:hover { background: #475569; }
.tm_ntm-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
@keyframes tm_ntm_glow { 0% { filter: drop-shadow(0 0 6px #10b981); } 100% { filter: drop-shadow(0 0 2px #10b981); } }

/* Enhancement: Classification (slide 16) */
.tm_cls-panel { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-top: 12px; }
.tm_cls-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.tm_cls-buttons button { background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
.tm_cls-buttons button:hover { background: #334155; border-color: #93c5fd; }
.tm_cls-buttons button.active { border-color: #93c5fd; background: rgba(59,130,246,0.2); }
.tm_cls-result { text-align: center; min-height: 3em; margin-top: 8px; font-size: 0.92em; color: #94a3b8; }
@keyframes tm_cls_spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Enhancement: Venn Diagram (slide 19) */
.tm_venn-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; justify-content: center; }
.tm_venn-buttons button { background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.82em; transition: all 0.2s; }
.tm_venn-buttons button:hover { background: #334155; border-color: #93c5fd; }
.tm_venn-msg { text-align: center; font-size: 0.9em; color: #94a3b8; min-height: 1.5em; margin-top: 6px; }
@keyframes tm_venn_pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
</style>
</head>
<body>

<div class="progress" id="progress"></div>

<!-- ============================== SLIDE 1 ============================== -->
<div class="slide active" id="s1">
  <div class="center">
    <h1>Turing Machines</h1>
    <p class="subtitle">The Ultimate Model of Computation</p>
    <div style="margin:20px auto; max-width:660px;">
      <svg id="tm_hero_svg" viewBox="0 0 660 170" width="660" style="max-width:100%;">
        <!-- Tape cells -->
        <g id="tm_hero_tape"></g>
        <!-- Head -->
        <polygon id="tm_hero_head" points="330,95 320,110 340,110" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
        <!-- Finite control box -->
        <rect x="265" y="118" width="130" height="48" rx="10" fill="#1e293b" stroke="#475569" stroke-width="1.5"/>
        <text x="330" y="138" text-anchor="middle" fill="#94a3b8" font-size="10" font-family="system-ui">Finite Control</text>
        <text id="tm_hero_state" x="330" y="156" text-anchor="middle" fill="#93c5fd" font-size="16" font-weight="bold" font-family="monospace">qâ‚€</text>
      </svg>
    </div>
    <p class="subtitle" style="margin-top:16px;">CS305 - Formal Language Theory</p>
    <p style="color:#64748b; font-size:0.95em;">Arrow keys or Space to navigate</p>
  </div>
  <div class="slide-number">1 / 23</div>
</div>

<!-- ============================== SLIDE 2 ============================== -->
<div class="slide" id="s2">
  <h2>Big Picture: The Chomsky Hierarchy</h2>
  <p>We've been climbing a ladder of computational power. The Turing Machine sits at the very top.</p>

  <div class="two-col">
    <div>
      <div class="diagram" style="font-size:0.82em;">
+-----------------------------------------------+
|  Type 0: Recursively Enumerable  (TM)         |
|                                                |
|  +----------------------------------------+   |
|  |  Type 1: Context-Sensitive  (LBA)      |   |
|  |                                        |   |
|  |  +----------------------------------+  |   |
|  |  |  Type 2: Context-Free  (PDA)     |  |   |
|  |  |                                  |  |   |
|  |  |  +----------------------------+  |  |   |
|  |  |  | Type 3: Regular  (DFA/NFA) |  |  |   |
|  |  |  +----------------------------+  |  |   |
|  |  +----------------------------------+  |   |
|  +----------------------------------------+   |
+-----------------------------------------------+
      </div>
    </div>
    <div>
      <table>
        <tr><th>Type</th><th>Grammar</th><th>Machine</th></tr>
        <tr><td>3</td><td>Regular</td><td>DFA / NFA</td></tr>
        <tr><td>2</td><td>Context-Free</td><td>PDA</td></tr>
        <tr><td>1</td><td>Context-Sensitive</td><td>LBA</td></tr>
        <tr class="highlight"><td>0</td><td>Unrestricted</td><td>TM</td></tr>
      </table>
      <div class="key-idea" style="margin-top:20px;">
        <h3>Key Idea</h3>
        <p>Each level strictly contains the one below it. TMs can do <strong>everything</strong> the lower models can, and more.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">2 / 23</div>
</div>

<!-- ============================== SLIDE 3 ============================== -->
<div class="slide" id="s3">
  <h2>Motivation: Why Go Beyond PDAs?</h2>
  <p>PDAs are powerful, but there are simple-sounding languages they cannot recognize.</p>

  <div class="two-col">
    <div>
      <h3>Languages PDAs Cannot Handle</h3>
      <ul>
        <li><strong>{ a<sup>n</sup>b<sup>n</sup>c<sup>n</sup> | n &ge; 1 }</strong> &mdash; needs to "count" three things at once, but a stack can only match two</li>
        <li><strong>{ ww | w &isin; {a,b}* }</strong> &mdash; exact copy. The stack reverses, so it can match ww<sup>R</sup> but not ww</li>
        <li><strong>{ a<sup>n</sup> | n is a perfect square }</strong> &mdash; requires arithmetic beyond stack counting</li>
      </ul>
      <div class="warning">
        <h3>The Core Limitation</h3>
        <p>A PDA's stack is <strong>LIFO</strong> (last-in, first-out). It can only access the top. It cannot "go back" or "look deeper" without destroying data above.</p>
      </div>
    </div>
    <div>
      <div class="tm_pda-panel">
        <h3 style="font-size:1.05em; margin-bottom:8px;">Watch a PDA Fail</h3>
        <div class="tm_pda-buttons">
          <button onclick="tm_pda_run(0)">Try a<sup>n</sup>b<sup>n</sup>c<sup>n</sup></button>
          <button onclick="tm_pda_run(1)">Try ww (copy)</button>
          <button onclick="tm_pda_run(2)">Try a<sup>n&sup2;</sup></button>
        </div>
        <div style="display:flex; gap:16px; align-items:start;">
          <div style="flex:1;">
            <div style="font-size:0.8em; color:#64748b; text-align:center; margin-bottom:4px;">Input Tape</div>
            <div class="tm_pda-input-tape" id="tm_pda_tape"></div>
          </div>
          <div style="width:80px;">
            <div style="font-size:0.8em; color:#64748b; text-align:center; margin-bottom:4px;">Stack</div>
            <div class="tm_pda-stack" id="tm_pda_stack">
              <div class="tm_pda-cell">$</div>
            </div>
          </div>
        </div>
        <div class="tm_pda-msg" id="tm_pda_msg">Click a language above to see why a PDA cannot handle it.</div>
      </div>
    </div>
  </div>
  <div class="slide-number">3 / 23</div>
</div>

<!-- ============================== SLIDE 4 ============================== -->
<div class="slide" id="s4">
  <h2>Alan Turing and the Origins</h2>

  <div class="two-col">
    <div>
      <h3>The Year: 1936</h3>
      <ul>
        <li>No electronic computers existed yet</li>
        <li>Mathematicians were asking: <em>"What does it mean for a problem to be computable?"</em></li>
        <li>Alan Turing, a 23-year-old Cambridge mathematician, published <strong>"On Computable Numbers"</strong></li>
        <li>He invented an abstract machine &mdash; not to build, but to <strong>define computation itself</strong></li>
      </ul>
      <div class="key-idea" style="margin-top:16px;">
        <h3>Key Idea</h3>
        <p>Turing didn't design a computer. He defined <strong>what "computable" means</strong>. His machine is a mathematical object, not an engineering blueprint.</p>
      </div>
    </div>
    <div>
      <h3>The Historical Context</h3>
      <ul>
        <li><strong>David Hilbert (1928)</strong> posed the <em>Entscheidungsproblem</em>: "Is there a mechanical procedure to decide all mathematical truths?"</li>
        <li><strong>Alonzo Church (1936)</strong> answered "no" using lambda calculus</li>
        <li><strong>Alan Turing (1936)</strong> independently answered "no" using his machines &mdash; and proved undecidability of the Halting Problem</li>
      </ul>
      <div class="warning">
        <h3>Historical Note</h3>
        <p>Church and Turing arrived at the same answer by different paths. Their equivalence is part of what gives us confidence in the Church-Turing Thesis (Slide 17).</p>
      </div>
    </div>
  </div>
  <div class="slide-number">4 / 23</div>
</div>

<!-- ============================== SLIDE 5 (Enhanced: Animated TM SVG) ============================== -->
<div class="slide" id="s5">
  <h2>The Turing Machine Model</h2>
  <p>A TM consists of three parts: an <strong>infinite tape</strong>, a <strong>read/write head</strong>, and a <strong>finite control</strong>.</p>

  <div style="text-align:center;">
    <svg id="tm_mach_svg" viewBox="0 0 750 280" width="700" style="max-width:100%;">
      <!-- Tape cells -->
      <g id="tm_mach_tape"></g>
      <!-- Head arrow -->
      <g id="tm_mach_head">
        <polygon id="tm_mach_arrow" points="0,-12 -10,8 10,8" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
        <text id="tm_mach_head_label" x="0" y="24" text-anchor="middle" fill="#fbbf24" font-size="12" font-family="system-ui">Head</text>
      </g>
      <!-- Connector line -->
      <line id="tm_mach_connector" x1="375" y1="135" x2="375" y2="160" stroke="#475569" stroke-width="2"/>
      <!-- Finite Control box -->
      <rect id="tm_mach_fc_box" x="285" y="160" width="180" height="90" rx="14" fill="#1e293b" stroke="#475569" stroke-width="2"/>
      <text x="375" y="188" text-anchor="middle" fill="#94a3b8" font-size="13" font-family="system-ui">Finite Control</text>
      <text id="tm_mach_state_text" x="375" y="218" text-anchor="middle" fill="#93c5fd" font-size="22" font-weight="bold" font-family="monospace">State: q0</text>
      <text id="tm_mach_action_text" x="375" y="240" text-anchor="middle" fill="#64748b" font-size="11" font-family="system-ui"></text>
    </svg>
  </div>
  <div class="tm_mach-controls">
    <button id="tm_mach_step_btn" onclick="tm_mach_step()">Step</button>
    <button id="tm_mach_run_btn" onclick="tm_mach_run()">Run</button>
    <button onclick="tm_mach_reset()">Reset</button>
  </div>
  <div class="tm_mach-status" id="tm_mach_status">Demo: TM replaces 0&rarr;X and 1&rarr;Y, then accepts. Click Step or Run.</div>

  <div class="two-col" style="margin-top:10px;">
    <div>
      <h3>The Three Components</h3>
      <ul>
        <li><strong>Tape:</strong> Divided into cells, each holding one symbol. Extends infinitely in both directions. Blank symbol (B) fills unused cells.</li>
        <li><strong>Head:</strong> Points to one cell at a time. Can <em>read</em> the symbol, <em>write</em> a new symbol, and <em>move</em> left or right.</li>
        <li><strong>Finite Control:</strong> A finite set of states plus a transition function that dictates behavior.</li>
      </ul>
    </div>
    <div>
      <div class="analogy">
        <h3>Analogy</h3>
        <p>Think of a Turing Machine as the <strong>simplest possible general-purpose computer</strong>. The tape is RAM (but infinite). The head is the read/write mechanism. The finite control is the CPU running a fixed program.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">5 / 23</div>
</div>

<!-- ============================== SLIDE 6 ============================== -->
<div class="slide" id="s6">
  <h2>Key Differences from PDA</h2>
  <p>The Turing Machine lifts every major restriction the PDA has.</p>

  <div class="two-col">
    <div>
      <table>
        <tr><th>Feature</th><th>PDA</th><th>TM</th></tr>
        <tr><td>Input</td><td>Read only</td><td>Read & Write</td></tr>
        <tr><td>Head movement</td><td>Left to right only</td><td>Left & Right</td></tr>
        <tr><td>Memory</td><td>Stack (LIFO)</td><td>Infinite tape</td></tr>
        <tr><td>Memory access</td><td>Top of stack only</td><td>Any cell</td></tr>
        <tr><td>Input handling</td><td>Separate input tape</td><td>Input on same tape</td></tr>
        <tr><td>Acceptance</td><td>Final state or empty stack</td><td>Final state + halt</td></tr>
        <tr class="highlight"><td>Power</td><td>Context-free</td><td>Recursively Enumerable</td></tr>
      </table>
    </div>
    <div>
      <div class="tm_cmp-panel">
        <button class="tm_cmp-btn" id="tm_cmp_btn" onclick="tm_cmp_run()">Watch: Process a&sup2;b&sup2;c&sup2;</button>
        <div class="tm_cmp-sides">
          <div class="tm_cmp-side" id="tm_cmp_pda_side">
            <h4 style="color:#f87171;">PDA</h4>
            <div style="font-size:0.75em; color:#64748b; margin-bottom:4px;">Input (one-way &rarr;)</div>
            <svg id="tm_cmp_pda_svg" viewBox="0 0 230 120" width="220" style="max-width:100%;"></svg>
          </div>
          <div class="tm_cmp-side" id="tm_cmp_tm_side">
            <h4 style="color:#34d399;">Turing Machine</h4>
            <div style="font-size:0.75em; color:#64748b; margin-bottom:4px;">Tape (&larr; &rarr;)</div>
            <svg id="tm_cmp_tm_svg" viewBox="0 0 230 120" width="220" style="max-width:100%;"></svg>
          </div>
        </div>
        <div class="tm_cmp-step" id="tm_cmp_step"></div>
      </div>
    </div>
  </div>
  <div class="slide-number">6 / 23</div>
</div>

<!-- ============================== SLIDE 7 ============================== -->
<div class="slide" id="s7">
  <h2>Formal Definition: The 7-Tuple</h2>
  <p>A Turing Machine is formally defined as <strong>M = (Q, &Sigma;, &Gamma;, &delta;, q<sub>0</sub>, B, F)</strong></p>

  <div class="two-col">
    <div>
      <table>
        <tr><th>Symbol</th><th>Name</th><th>Description</th></tr>
        <tr><td><strong>Q</strong></td><td>States</td><td>Finite set of states</td></tr>
        <tr><td><strong>&Sigma;</strong></td><td>Input alphabet</td><td>Symbols that appear in input (&Sigma; &sub; &Gamma;, B &notin; &Sigma;)</td></tr>
        <tr><td><strong>&Gamma;</strong></td><td>Tape alphabet</td><td>All symbols that can appear on tape (&Sigma; &cup; {B} &sube; &Gamma;)</td></tr>
        <tr><td><strong>&delta;</strong></td><td>Transition fn</td><td>Q &times; &Gamma; &rarr; Q &times; &Gamma; &times; {L, R}</td></tr>
        <tr><td><strong>q<sub>0</sub></strong></td><td>Start state</td><td>q<sub>0</sub> &isin; Q</td></tr>
        <tr><td><strong>B</strong></td><td>Blank symbol</td><td>B &isin; &Gamma; but B &notin; &Sigma;</td></tr>
        <tr><td><strong>F</strong></td><td>Final states</td><td>F &sube; Q (accepting states)</td></tr>
      </table>
    </div>
    <div>
      <div class="key-idea">
        <h3>Key Idea: Input vs Tape Alphabet</h3>
        <p><strong>&Sigma;</strong> is what the input is made of (e.g., {0, 1}). <strong>&Gamma;</strong> is everything that can be on the tape, including &Sigma;, the blank B, and any extra "work" symbols (e.g., X, Y for marking).</p>
      </div>
      <div class="diagram" style="font-size:0.85em;">
Example:
  Q = {q0, q1, q2, q3, q4}
  &Sigma; = {0, 1}
  &Gamma; = {0, 1, X, Y, B}
  q0 = q0
  B  = B  (the blank)
  F  = {q4}
      </div>
      <div class="warning">
        <h3>Watch Out</h3>
        <p>The blank symbol B is in &Gamma; but NOT in &Sigma;. The input never contains blanks &mdash; blanks only appear as the "empty" cells on the tape.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">7 / 23</div>
</div>

<!-- ============================== SLIDE 8 (Enhanced: Transition Explorer) ============================== -->
<div class="slide" id="s8">
  <h2>The Transition Function</h2>
  <p>Each transition has three parts: <strong>what to write</strong>, <strong>where to move</strong>, and <strong>which state to enter</strong>.</p>

  <div class="diagram" style="font-size:1.1em; text-align:center;">
                &delta;( q , X )  =  ( p , Y , D )
                     |   |        |   |   |
                     |   |        |   |   +-- Direction: L (left) or R (right)
                     |   |        |   +------ Symbol to WRITE on tape
                     |   |        +---------- New state to enter
                     |   +------------------- Symbol currently READ from tape
                     +----------------------- Current state
  </div>

  <div class="two-col" style="margin-top:10px;">
    <div>
      <h3>Reading a Transition</h3>
      <p><strong>&delta;(q<sub>1</sub>, 0) = (q<sub>2</sub>, X, R)</strong></p>
      <p>Means: "If you are in state q<sub>1</sub> and the head reads 0, then:</p>
      <ul>
        <li>Write <strong>X</strong> over the 0</li>
        <li>Move the head <strong>right</strong></li>
        <li>Go to state <strong>q<sub>2</sub></strong>"</li>
      </ul>
      <div class="diagram small">
Before:          After:
...[ 0 ][ 1 ]   ...[ X ][ 1 ]
     ^                    ^
    q1                   q2
      </div>
    </div>
    <div>
      <h3>Halting</h3>
      <p>The TM <strong>halts</strong> when &delta;(q, X) is undefined &mdash; there is no transition for the current state and tape symbol.</p>
      <ul>
        <li><strong>Accept:</strong> Halt in a state q &isin; F</li>
        <li><strong>Reject:</strong> Halt in a state q &notin; F</li>
        <li><strong>Loop:</strong> Never halt (possible!)</li>
      </ul>
      <div class="warning">
        <h3>Warning</h3>
        <p>Unlike DFAs and PDAs, a TM might <strong>never stop</strong>. This is not a bug &mdash; it's a fundamental feature that leads to undecidability.</p>
      </div>
    </div>
  </div>

  <!-- Interactive Transition Explorer Panel -->
  <div class="tm_trx-panel">
    <h3 style="font-size:1.1em; margin-bottom:10px;">Try It: Transition Explorer</h3>
    <div class="tm_trx-buttons">
      <button onclick="tm_trx_play(0)">&delta;(q1, 0) = (q2, X, R)</button>
      <button onclick="tm_trx_play(1)">&delta;(q2, 1) = (q3, Y, L)</button>
      <button onclick="tm_trx_play(2)">&delta;(q0, B) = (q1, B, R)</button>
      <button onclick="tm_trx_play(3)">&delta;(q3, X) = (q3, X, R)</button>
    </div>
    <div style="text-align:center;">
      <svg id="tm_trx_svg" viewBox="0 0 500 60" width="480" style="max-width:100%;"></svg>
    </div>
    <div class="tm_trx-narration" id="tm_trx_narration">Click a transition above to see it animated.</div>
  </div>

  <div class="slide-number">8 / 23</div>
</div>

<!-- ============================== SLIDE 9 ============================== -->
<div class="slide" id="s9">
  <h2>Instantaneous Description (ID)</h2>
  <p>An ID captures the <strong>complete configuration</strong> of a TM at any point in its computation.</p>

  <div class="two-col">
    <div>
      <h3>Format: X<sub>1</sub>X<sub>2</sub>...X<sub>i-1</sub> <strong>q</strong> X<sub>i</sub>...X<sub>n</sub></h3>
      <p>The state symbol <strong>q</strong> appears immediately <em>before</em> the symbol the head is currently reading.</p>

      <div class="diagram" style="font-size:0.9em;">
Tape: ...B [ 0 ] [ 1 ] [ 1 ] [ 0 ] B...
                   ^
                 state q2

ID:   0 q2 1 1 0

  - "0" is to the left of the head
  - "q2" is the current state
  - "1 1 0" is at and to the right
  - head reads the first symbol
    after the state: "1"
      </div>
    </div>
    <div>
      <h3>Moves as ID Transitions</h3>
      <p>If &delta;(q, X<sub>i</sub>) = (p, Y, R) then:</p>
      <div class="diagram small">
X1...Xi-1 q Xi Xi+1...Xn
          |
          v    (move right)
X1...Xi-1 Y p Xi+1...Xn
      </div>
      <p>If &delta;(q, X<sub>i</sub>) = (p, Y, L) then:</p>
      <div class="diagram small">
X1...Xi-2 Xi-1 q Xi...Xn
                |
                v    (move left)
X1...Xi-2 p Xi-1 Y...Xn
      </div>
      <div class="key-idea">
        <h3>Key Idea</h3>
        <p>IDs let us write an entire computation as a sequence:
        <br><strong>ID<sub>1</sub> |- ID<sub>2</sub> |- ID<sub>3</sub> |- ... |- ID<sub>n</sub></strong>
        <br>where |- means "yields in one step."</p>
      </div>
    </div>
  </div>

  <!-- Interactive ID Transition Explorer -->
  <div class="tm_id-panel">
    <h3 style="font-size:1.05em; margin-bottom:8px;">Try It: ID Transitions</h3>
    <div class="tm_id-buttons">
      <button onclick="tm_id_play(0)">0 q&#x2081; 110 &rarr; 0X q&#x2082; 10</button>
      <button onclick="tm_id_play(1)">01 q&#x2083; 10 &rarr; 0 q&#x2084; 1Y0</button>
      <button onclick="tm_id_play(2)">q&#x2080; 011 &rarr; X q&#x2081; 11</button>
      <button onclick="tm_id_play(3)">XY q&#x2083; YB &rarr; XYY q&#x2080; B</button>
    </div>
    <div style="text-align:center;">
      <svg id="tm_id_svg" viewBox="0 0 500 70" width="480" style="max-width:100%;"></svg>
    </div>
    <div class="tm_id-text" id="tm_id_text">Click a transition to visualize it on the tape.</div>
  </div>

  <div class="slide-number">9 / 23</div>
</div>

<!-- ============================== SLIDE 10 ============================== -->
<div class="slide" id="s10">
  <h2>Example 1: TM for { 0<sup>n</sup>1<sup>n</sup> | n &ge; 1 }</h2>
  <p>Strategy: <strong>Zig-zag</strong> across the tape, crossing off one 0 and one 1 on each pass.</p>

  <div class="two-col">
    <div>
      <h3>The Zig-Zag Strategy</h3>
      <div class="diagram small">
Pass 1:  [ 0 ][ 0 ][ 1 ][ 1 ]
          ^
         Cross off leftmost 0 (write X)
         Scan right to find leftmost 1
         Cross it off (write Y)
         Scan left back to start

         [ X ][ 0 ][ Y ][ 1 ]

Pass 2:  Skip X's, find next 0
         Cross it off (write X)
         Scan right, skip Y's, find 1
         Cross it off (write Y)
         Scan left back

         [ X ][ X ][ Y ][ Y ]

Check:   No more 0's? No more 1's?
         All matched => ACCEPT!
      </div>
    </div>
    <div>
      <h3>Transition Table</h3>
      <table style="font-size:0.85em;">
        <tr><th>State</th><th>Read</th><th>Write</th><th>Move</th><th>Next</th></tr>
        <tr><td>q0</td><td>0</td><td>X</td><td>R</td><td>q1</td></tr>
        <tr><td>q0</td><td>Y</td><td>Y</td><td>R</td><td>q3</td></tr>
        <tr><td>q1</td><td>0</td><td>0</td><td>R</td><td>q1</td></tr>
        <tr><td>q1</td><td>Y</td><td>Y</td><td>R</td><td>q1</td></tr>
        <tr><td>q1</td><td>1</td><td>Y</td><td>L</td><td>q2</td></tr>
        <tr><td>q2</td><td>0</td><td>0</td><td>L</td><td>q2</td></tr>
        <tr><td>q2</td><td>Y</td><td>Y</td><td>L</td><td>q2</td></tr>
        <tr><td>q2</td><td>X</td><td>X</td><td>R</td><td>q0</td></tr>
        <tr><td>q3</td><td>Y</td><td>Y</td><td>R</td><td>q3</td></tr>
        <tr class="highlight"><td>q3</td><td>B</td><td>B</td><td>R</td><td>q4</td></tr>
      </table>
      <p style="font-size:0.9em;"><strong>q4</strong> is the accept state. States: q0=find 0, q1=scan right for 1, q2=scan left, q3=verify done.</p>
    </div>
  </div>
  <div class="slide-number">10 / 23</div>
</div>

<!-- ============================== SLIDE 11 (Enhanced: TM Simulator) ============================== -->
<div class="slide" id="s11">
  <h2>Trace of TM on Input "0011"</h2>
  <p>Interactive simulator for the 0<sup>n</sup>1<sup>n</sup> zig-zag TM. Load an input and step through.</p>

  <div class="tm_sim-container">
    <div class="tm_sim-input-row">
      <label style="color:#94a3b8; font-size:0.95em;">Input:</label>
      <input type="text" id="tm_sim_input" value="0011" maxlength="12" placeholder="e.g. 0011">
      <button id="tm_sim_load_btn" onclick="tm_sim_load()">Load</button>
      <span style="color:#64748b; font-size:0.85em;">(only 0s and 1s)</span>
      <span style="margin-left:auto;">State: <span class="tm_sim-state" id="tm_sim_state_display" style="background:#1e3a5f; color:#93c5fd;">q0</span></span>
      <span id="tm_sim_state_desc" style="color:#94a3b8; font-size:0.85em;">Find next 0</span>
    </div>
    <div style="text-align:center;">
      <svg id="tm_sim_svg" viewBox="0 0 800 80" width="760" style="max-width:100%;"></svg>
    </div>
    <div class="tm_sim-controls">
      <button id="tm_sim_step_btn" onclick="tm_sim_step()" disabled>Step</button>
      <button id="tm_sim_run_btn" onclick="tm_sim_run()" disabled>Run</button>
      <button id="tm_sim_reset_btn" onclick="tm_sim_reset()">Reset</button>
      <label style="color:#64748b; font-size:0.85em; margin-left:12px;">Speed:</label>
      <input type="range" id="tm_sim_speed" min="1" max="10" value="5">
      <span id="tm_sim_step_counter" style="margin-left:auto; color:#64748b; font-size:0.9em;">Step 0 of 0</span>
    </div>
    <div class="tm_sim-verdict" id="tm_sim_verdict"></div>
    <div class="tm_sim-log" id="tm_sim_log"></div>
  </div>

  <div class="key-idea" style="margin-top:10px;">
    <h3>Key Idea: Why It Works</h3>
    <p>Each pass crosses off exactly one 0 and one 1. If all 0s and 1s get crossed off together, the counts were equal. If we run out of 1s before 0s (or vice versa), the TM halts in a non-accepting state.</p>
  </div>
  <div class="slide-number">11 / 23</div>
</div>

<!-- ============================== SLIDE 12 (Enhanced: Binary Increment) ============================== -->
<div class="slide" id="s12">
  <h2>Example 2: TM as a Transducer &mdash; Binary Increment</h2>
  <p>TMs can also <strong>compute functions</strong>, not just decide languages. Here: add 1 to a binary number.</p>

  <div class="two-col">
    <div>
      <h3>Strategy</h3>
      <ul>
        <li>Start with the head at the <strong>rightmost bit</strong></li>
        <li>If it's <strong>0</strong>: change to 1, done</li>
        <li>If it's <strong>1</strong>: change to 0 (carry), move left, repeat</li>
        <li>If it's <strong>B</strong> (blank, went past all digits): write 1 (carry into new position)</li>
      </ul>

      <div class="diagram small">
&delta;(q0, 0) = (qf, 1, R)   -- flip 0->1, halt
&delta;(q0, 1) = (q0, 0, L)   -- flip 1->0, carry
&delta;(q0, B) = (qf, 1, R)   -- carry into blank
      </div>
    </div>
    <div>
      <div class="tm_inc-container">
        <h3 style="font-size:1.05em; margin-bottom:8px;">Interactive Simulator</h3>
        <div class="tm_inc-input-row">
          <input type="text" id="tm_inc_input" value="1011" maxlength="10" placeholder="e.g. 1011">
          <button id="tm_inc_load_btn" onclick="tm_inc_load()">Load</button>
          <span style="color:#64748b; font-size:0.8em;">(0s and 1s)</span>
        </div>
        <div style="text-align:center;">
          <svg id="tm_inc_svg" viewBox="0 0 450 70" width="420" style="max-width:100%;"></svg>
        </div>
        <div class="tm_inc-controls">
          <button id="tm_inc_step_btn" onclick="tm_inc_step()" disabled>Step</button>
          <button id="tm_inc_run_btn" onclick="tm_inc_run()" disabled>Run</button>
          <button onclick="tm_inc_reset()">Reset</button>
          <span id="tm_inc_state_label" style="margin-left:auto; color:#94a3b8; font-size:0.85em;">State: q0</span>
        </div>
        <div class="tm_inc-result" id="tm_inc_result"></div>
      </div>
    </div>
  </div>

  <div class="analogy">
    <h3>Analogy</h3>
    <p>This is exactly how you add 1 by hand: start from the right, flip bits, and carry the 1 leftward until you find a 0 to absorb it.</p>
  </div>
  <div class="slide-number">12 / 23</div>
</div>

<!-- ============================== SLIDE 13 ============================== -->
<div class="slide" id="s13">
  <h2>TM Programming Techniques</h2>
  <p>Building TMs for complex tasks uses a few recurring "tricks."</p>

  <div class="two-col">
    <div>
      <h3>1. Marking Symbols</h3>
      <p>Replace a symbol with a "marked" version (e.g., 0 &rarr; X) to remember you've processed it. This is what our 0<sup>n</sup>1<sup>n</sup> TM did.</p>

      <h3 class="mt">2. Shifting</h3>
      <p>To insert or delete a symbol, shift all symbols right/left by one cell. Requires O(n) steps per shift.</p>
      <div class="diagram small">
Insert 'A' at position 3:
Before: [ a ][ b ][ c ][ d ]
After:  [ a ][ b ][ A ][ c ][ d ]
      </div>

      <h3 class="mt">3. Multiple Tracks</h3>
      <p>Treat each tape cell as holding a <em>tuple</em> of symbols. E.g., one track for data, one for markers.</p>
    </div>
    <div>
      <div class="diagram small">
Multiple Tracks (single tape):
+-------+-------+-------+-------+
| (0,#) | (1,*) | (1,#) | (0,#) |
+-------+-------+-------+-------+
Track 1:  0  1  1  0   (data)
Track 2:  #  *  #  #   (markers)

&Gamma; includes all pairs: (0,#),(0,*),
(1,#),(1,*), etc.
      </div>

      <h3>4. Subroutines</h3>
      <p>Design a TM for a subtask (e.g., "shift right"), then "call" it by entering its start state, with a designated "return" state that hands control back.</p>

      <div class="key-idea">
        <h3>Key Idea</h3>
        <p>These techniques show that TMs, despite their simplicity, can simulate structured programming concepts: variables (marked cells), arrays (tape regions), and function calls (subroutines).</p>
      </div>
    </div>
  </div>
  <div class="slide-number">13 / 23</div>
</div>

<!-- ============================== SLIDE 14 ============================== -->
<div class="slide" id="s14">
  <h2>Multi-Tape Turing Machines</h2>
  <p>A multi-tape TM has <strong>k tapes</strong>, each with its own independent read/write head.</p>

  <div style="text-align:center;">
    <svg id="tm_mt_svg" viewBox="0 0 700 240" width="660" style="max-width:100%;"></svg>
  </div>
  <div class="tm_mt-controls">
    <button id="tm_mt_step_btn" onclick="tm_mt_step()">Step</button>
    <button id="tm_mt_run_btn" onclick="tm_mt_run()">Run</button>
    <button onclick="tm_mt_reset()">Reset</button>
  </div>
  <div class="tm_mt-status" id="tm_mt_status">Demo: 2-tape TM copies input from Tape 1 to Tape 2. Click Step or Run.</div>

  <div class="two-col" style="margin-top:10px;">
    <div>
      <h3>Transition</h3>
      <p>&delta;(q, a<sub>1</sub>, a<sub>2</sub>, ..., a<sub>k</sub>) = (p, b<sub>1</sub>, b<sub>2</sub>, ..., b<sub>k</sub>, D<sub>1</sub>, D<sub>2</sub>, ..., D<sub>k</sub>)</p>
      <p>Reads all k heads at once, writes to all, moves each independently.</p>
    </div>
    <div>
      <div class="key-idea">
        <h3>Equivalence Theorem</h3>
        <p>Every multi-tape TM can be simulated by a <strong>single-tape TM</strong>. The single tape encodes all k tapes using multiple tracks and markers for head positions. This costs at most a <strong>polynomial slowdown</strong>.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">14 / 23</div>
</div>

<!-- ============================== SLIDE 15 ============================== -->
<div class="slide" id="s15">
  <h2>Nondeterministic Turing Machines</h2>
  <p>A Nondeterministic TM (NTM) can have <strong>multiple possible transitions</strong> for the same (state, symbol) pair.</p>

  <div class="two-col">
    <div>
      <div class="diagram small">
Deterministic TM:
  &delta;(q1, a) = (q2, b, R)
  (exactly ONE choice)

Nondeterministic TM:
  &delta;(q1, a) = { (q2, b, R),
                 (q3, a, L),
                 (q5, c, R) }
  (MULTIPLE choices -- pick any)
      </div>

      <h3 class="mt">Acceptance</h3>
      <p>An NTM accepts if <strong>at least one</strong> computation path reaches an accepting state. Think of it as exploring a tree of possibilities.</p>

      <div style="text-align:center;">
        <svg id="tm_ntm_svg" viewBox="0 0 350 200" width="330" style="max-width:100%;"></svg>
      </div>
      <div class="tm_ntm-controls">
        <button id="tm_ntm_run_btn" onclick="tm_ntm_run()">Run NTM</button>
        <button onclick="tm_ntm_reset()">Reset</button>
      </div>
    </div>
    <div>
      <div class="key-idea">
        <h3>Equivalence Theorem</h3>
        <p>NTMs are <strong>equivalent in power</strong> to deterministic TMs. Every NTM can be simulated by a DTM (using breadth-first search of the computation tree).</p>
      </div>
      <div class="warning">
        <h3>But There's a Catch</h3>
        <p>The simulation may be <strong>exponentially slower</strong>. If the NTM runs in time t, the DTM simulation might take O(c<sup>t</sup>) steps. Whether this exponential blowup is <em>necessary</em> is the famous <strong>P vs NP problem</strong>!</p>
      </div>
      <div class="analogy">
        <h3>Analogy</h3>
        <p>An NTM is like a "lucky guesser" &mdash; it always picks the right branch. A DTM is like a methodical searcher who has to try every branch. They solve the same problems, but the guesser might be much faster.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">15 / 23</div>
</div>

<!-- ============================== SLIDE 16 ============================== -->
<div class="slide" id="s16">
  <h2>Decidable vs. Recognizable Languages</h2>
  <p>TMs introduce a crucial distinction based on whether they always halt.</p>

  <div class="two-col">
    <div>
      <h3>Decidable (Recursive)</h3>
      <div class="diagram small">
Input w
  |
  v
+--------+      +-----+
|   TM   |----->| YES |  (accept)
|        |      +-----+
| ALWAYS |
| HALTS  |      +-----+
|        |----->| NO  |  (reject)
+--------+      +-----+

Guaranteed: one of these two.
      </div>
      <p>The TM <strong>always halts</strong>, either accepting or rejecting. You always get a definitive answer.</p>
    </div>
    <div>
      <h3>Recognizable (Recursively Enumerable)</h3>
      <div class="diagram small">
Input w
  |
  v
+--------+      +-----+
|   TM   |----->| YES |  (accept)
|        |      +-----+
| MIGHT  |
| LOOP   |      +----------+
|        |----->| LOOP ... |  (no answer)
+--------+      +----------+

If w is in L: TM accepts.
If w is NOT in L: TM might loop
                  forever!
      </div>
      <p>The TM accepts all strings in L, but may <strong>loop forever</strong> on strings not in L.</p>
    </div>
  </div>

  <!-- Interactive Classification Panel -->
  <div class="tm_cls-panel">
    <h3 style="font-size:1.05em; margin-bottom:8px;">Try It: Classify These Languages</h3>
    <div class="tm_cls-buttons">
      <button onclick="tm_cls_show(0)">{ a<sup>n</sup>b<sup>n</sup> | n&ge;0 }</button>
      <button onclick="tm_cls_show(1)">{ valid C programs }</button>
      <button onclick="tm_cls_show(2)">Halting Problem (A<sub>TM</sub>)</button>
      <button onclick="tm_cls_show(3)">Complement of A<sub>TM</sub></button>
      <button onclick="tm_cls_show(4)">{ a<sup>n</sup>b<sup>n</sup>c<sup>n</sup> }</button>
      <button onclick="tm_cls_show(5)">All strings over {a,b}</button>
    </div>
    <div style="text-align:center;">
      <svg id="tm_cls_svg" viewBox="0 0 500 80" width="480" style="max-width:100%;"></svg>
    </div>
    <div class="tm_cls-result" id="tm_cls_result">Click a language above to classify it.</div>
  </div>

  <div class="warning" style="margin-top:10px;">
    <h3>Warning: This Distinction Matters!</h3>
    <p>If a TM loops on input w, you can never be sure whether it will eventually halt or loop forever. There is no general way to detect this &mdash; that's the <strong>Halting Problem</strong>.</p>
  </div>
  <div class="slide-number">16 / 23</div>
</div>

<!-- ============================== SLIDE 17 ============================== -->
<div class="slide" id="s17">
  <h2>The Church-Turing Thesis</h2>
  <p>The most important <em>philosophical</em> claim in computer science.</p>

  <div class="key-idea" style="font-size:1.1em; margin:20px 0;">
    <h3>The Church-Turing Thesis</h3>
    <p><em>"Every function that would naturally be regarded as computable can be computed by a Turing Machine."</em></p>
    <p style="margin-top:10px;">Equivalently: <strong>if there's an algorithm for it, a TM can do it.</strong></p>
  </div>

  <div class="two-col">
    <div>
      <h3>What It IS</h3>
      <ul>
        <li>A <strong>thesis</strong> (claim / belief / hypothesis)</li>
        <li>Supported by overwhelming evidence</li>
        <li>Every proposed model of computation (lambda calculus, recursive functions, Post systems, RAM machines, ...) turned out to be <strong>equivalent</strong> to TMs</li>
        <li>No one has ever found a counterexample</li>
      </ul>
    </div>
    <div>
      <h3>What It is NOT</h3>
      <ul>
        <li><strong>Not a theorem</strong> &mdash; it cannot be formally "proved"</li>
        <li>Not about efficiency (a TM might be astronomically slow)</li>
        <li>Could theoretically be "falsified" if someone found a new model that computes something TMs can't</li>
      </ul>
      <div class="warning">
        <h3>Common Mistake</h3>
        <p>Students often treat it as a proven fact. It is <strong>not a theorem</strong>. It is a universally accepted <strong>belief</strong> backed by 90 years of evidence. No proof exists because "effective procedure" has no formal definition outside of it.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">17 / 23</div>
</div>

<!-- ============================== SLIDE 18 ============================== -->
<div class="slide" id="s18">
  <h2>Turing Machines and Modern Computers</h2>
  <p>Your laptop is, in theory, no more powerful than a Turing Machine.</p>

  <div class="two-col">
    <div>
      <h3>What They Share</h3>
      <div class="diagram small">
+-------------+     +-----------------+
| Your Laptop |     | Turing Machine  |
+-------------+     +-----------------+
| CPU         | <=> | Finite Control  |
| RAM + Disk  | <=> | Infinite Tape   |
| Program     | <=> | Transition fn   |
| Input file  | <=> | Initial tape    |
+-------------+     +-----------------+

Same languages recognized.
Same functions computed.
      </div>
      <p>If a problem can be solved by any computer ever built, a TM can solve it too (and vice versa).</p>
    </div>
    <div>
      <h3>The Differences</h3>
      <ul>
        <li><strong>Speed:</strong> Real computers are enormously faster (parallelism, caches, O(1) random access vs. O(n) tape traversal)</li>
        <li><strong>Memory:</strong> Real computers have finite memory. TMs have infinite tape. But we can always "buy more RAM" &mdash; the TM just assumes we always have enough.</li>
        <li><strong>Practicality:</strong> Nobody programs TMs. They're a <em>theoretical tool</em> for reasoning about what <em>can</em> and <em>can't</em> be computed.</li>
      </ul>
      <div class="analogy">
        <h3>Analogy</h3>
        <p>A TM is to a computer what a free-body diagram is to a bridge. Nobody builds a bridge from a free-body diagram directly &mdash; but it tells you whether the bridge <em>can</em> stand.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">18 / 23</div>
</div>

<!-- ============================== SLIDE 19 ============================== -->
<div class="slide" id="s19">
  <h2>Recursive and RE Languages</h2>
  <p>The landscape of all languages, organized by TM decidability.</p>

  <div class="two-col">
    <div>
      <div style="text-align:center;">
        <svg id="tm_venn_svg" viewBox="0 0 400 320" width="380" style="max-width:100%;"></svg>
      </div>
      <div class="tm_venn-buttons">
        <button onclick="tm_venn_fly(0)">a*b*</button>
        <button onclick="tm_venn_fly(1)">a<sup>n</sup>b<sup>n</sup>c<sup>n</sup></button>
        <button onclick="tm_venn_fly(2)">Halting Problem</button>
        <button onclick="tm_venn_fly(3)">Complement of HP</button>
        <button onclick="tm_venn_fly(4)">Every CFL</button>
        <button onclick="tm_venn_fly(5)">{ww}</button>
      </div>
      <div class="tm_venn-msg" id="tm_venn_msg">Click an example to see where it lives.</div>
    </div>
    <div>
      <h3>co-RE Languages</h3>
      <p>A language is <strong>co-RE</strong> if its <em>complement</em> is RE.</p>

      <div class="key-idea">
        <h3>Key Theorem</h3>
        <p>A language L is <strong>recursive</strong> (decidable) if and only if <strong>both L and its complement</strong> are RE.</p>
        <p style="margin-top:8px;">L is recursive &hArr; L &isin; RE &cap; co-RE</p>
      </div>

      <div class="diagram small">
          RE            co-RE
      +--------+    +--------+
      |   A_TM |    | ~A_TM  |
      |        |    |        |
      | +----+ |    | +----+ |
      | |Rec.| |    | |Rec.| |
      | +----+ |    | +----+ |
      +--------+    +--------+

Recursive = RE &cap; co-RE
      </div>
      <p>If L is RE but not co-RE (like the Halting Problem), then L is undecidable.</p>
    </div>
  </div>
  <div class="slide-number">19 / 23</div>
</div>

<!-- ============================== SLIDE 20 ============================== -->
<div class="slide" id="s20">
  <h2>Closure Properties</h2>
  <p>Which operations preserve decidability and recognizability?</p>

  <div style="display:flex; justify-content:center;">
    <table style="font-size:1.05em;">
      <tr><th>Operation</th><th>Recursive (Decidable)</th><th>RE (Recognizable)</th></tr>
      <tr><td>Union (L<sub>1</sub> &cup; L<sub>2</sub>)</td><td style="color:#34d399;">Closed</td><td style="color:#34d399;">Closed</td></tr>
      <tr><td>Intersection (L<sub>1</sub> &cap; L<sub>2</sub>)</td><td style="color:#34d399;">Closed</td><td style="color:#34d399;">Closed</td></tr>
      <tr><td>Complement (&overline;L})</td><td style="color:#34d399;">Closed</td><td style="color:#f87171;">NOT Closed</td></tr>
      <tr><td>Concatenation (L<sub>1</sub>L<sub>2</sub>)</td><td style="color:#34d399;">Closed</td><td style="color:#34d399;">Closed</td></tr>
      <tr><td>Kleene Star (L*)</td><td style="color:#34d399;">Closed</td><td style="color:#34d399;">Closed</td></tr>
    </table>
  </div>

  <div class="two-col" style="margin-top:20px;">
    <div>
      <div class="key-idea">
        <h3>Why Recursive is Closed Under Complement</h3>
        <p>If TM M always halts and decides L, just <strong>swap accept and reject</strong>. The new TM decides the complement. Easy!</p>
      </div>
    </div>
    <div>
      <div class="warning">
        <h3>Why RE is NOT Closed Under Complement</h3>
        <p>If M might loop on strings not in L, "swapping accept/reject" doesn't help &mdash; you can't swap "loop forever" with "accept." If RE were closed under complement, then RE &cap; co-RE = RE, making everything decidable. But the Halting Problem shows that's false.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">20 / 23</div>
</div>

<!-- ============================== SLIDE 21 ============================== -->
<div class="slide" id="s21">
  <h2>TM Variants: All Equivalent!</h2>
  <p>Many variations of the TM have been proposed. Remarkably, they all have the <strong>exact same computational power</strong>.</p>

  <div class="two-col">
    <div>
      <h3>The Variants</h3>
      <table style="font-size:0.9em;">
        <tr><th>Variant</th><th>Description</th></tr>
        <tr><td>Multi-tape</td><td>k independent tapes + heads</td></tr>
        <tr><td>Multi-track</td><td>Each cell holds a tuple of symbols</td></tr>
        <tr><td>2-way infinite</td><td>Tape extends infinitely in both directions</td></tr>
        <tr><td>Stay option</td><td>Head can stay put (L, R, or S)</td></tr>
        <tr><td>Multi-head</td><td>Multiple heads on one tape</td></tr>
        <tr><td>Nondeterministic</td><td>Multiple transitions per (state, symbol)</td></tr>
        <tr><td>Enumerator</td><td>Prints strings instead of accepting</td></tr>
      </table>
    </div>
    <div>
      <div class="diagram small">
Standard single-tape TM:
  ...[ ][ ][ a ][ b ][ c ][ ][ ]...
               ^
          finite control

is equivalent to ALL of these:

  Multi-tape:     k tapes
  Multi-head:     k heads, 1 tape
  2-way infinite: ...&lt;----tape----&gt;...
  Stay option:    head can stay
  NTM:            branching choices
      </div>
      <div class="key-idea">
        <h3>Why This Matters</h3>
        <p>This robustness is <strong>evidence for the Church-Turing Thesis</strong>. No matter how you tweak the TM model, you get the same class of computable functions. The notion of computability seems to be a <em>natural</em>, model-independent concept.</p>
      </div>
    </div>
  </div>
  <div class="slide-number">21 / 23</div>
</div>

<!-- ============================== SLIDE 22 ============================== -->
<div class="slide" id="s22">
  <h2>Summary &amp; Cheat Sheet</h2>

  <div class="two-col">
    <div>
      <h3>The TM in One Paragraph</h3>
      <p>A Turing Machine is an abstract device with a <strong>finite control</strong>, an <strong>infinite tape</strong>, and a <strong>read/write head</strong>. It reads a symbol, writes a symbol, moves left or right, and changes state. It is the most powerful standard model of computation &mdash; anything computable is TM-computable.</p>

      <h3 class="mt">Formal Definition</h3>
      <div class="diagram small">
M = (Q, &Sigma;, &Gamma;, &delta;, q0, B, F)

&delta;: Q x &Gamma; --> Q x &Gamma; x {L, R}

ID format: X1...Xi-1 q Xi...Xn
  (state before symbol head reads)
      </div>

      <h3 class="mt">Key Techniques</h3>
      <ul>
        <li>Marking symbols (0 &rarr; X)</li>
        <li>Zig-zag / shuttle strategy</li>
        <li>Multiple tracks</li>
        <li>Subroutines via state transitions</li>
      </ul>
    </div>
    <div>
      <h3>Language Classes</h3>
      <div class="diagram small">
Decidable (Recursive):
  TM halts on ALL inputs.
  Closed: &cup;, &cap;, complement, concat, *

RE (Recognizable):
  TM accepts w &isin; L; may loop if w &notin; L.
  Closed: &cup;, &cap;, concat, *
  NOT closed: complement

Recursive = RE &cap; co-RE
      </div>

      <h3 class="mt">Must-Know Facts</h3>
      <div class="key-idea">
        <ul>
          <li><strong>Church-Turing Thesis</strong> is NOT a theorem</li>
          <li>All TM variants (multi-tape, NTM, etc.) are <strong>equivalent</strong></li>
          <li>NTM &rarr; DTM simulation may be <strong>exponentially slower</strong></li>
          <li>TMs = modern computers in power (not speed)</li>
          <li>RE but not Recursive: <strong>Halting Problem</strong></li>
        </ul>
      </div>

      <h3 class="mt">Hierarchy Reminder</h3>
      <div class="diagram small">
Regular &sub; CFL &sub; Decidable &sub; RE &sub; All Languages
 DFA      PDA    TM(halts)   TM
      </div>
    </div>
  </div>
  <div class="slide-number">22 / 23</div>
</div>

<!-- ============================== SLIDE 23 (Enhancement 5: Quiz) ============================== -->
<div class="slide" id="s23">
  <h2>Challenge Quiz: Turing Machines</h2>
  <p class="tm_q1-progress" id="tm_q1_progress">Question 1 of 3</p>

  <div class="tm_q1-container" id="tm_q1_container">
    <!-- Questions are rendered by JS -->
  </div>
  <button class="tm_q1-retry" id="tm_q1_retry" onclick="tm_q1_init()">Try Again</button>
  <div class="slide-number">23 / 23</div>
</div>

<!-- Navigation -->
<div class="nav">
  <button id="prevBtn" onclick="changeSlide(-1)">&larr; Prev</button>
  <button id="nextBtn" onclick="changeSlide(1)">Next &rarr;</button>
</div>

<script>
const totalSlides = 23;
let current = 1;
function showSlide(n) {
  document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
  const slide = document.getElementById('s' + n);
  if (slide) { slide.classList.add('active'); slide.classList.add('fade-in'); }
  document.getElementById('prevBtn').disabled = (n === 1);
  document.getElementById('nextBtn').disabled = (n === totalSlides);
  document.getElementById('progress').style.width = ((n / totalSlides) * 100) + '%';
}
function changeSlide(delta) {
  const next = current + delta;
  if (next >= 1 && next <= totalSlides) { current = next; showSlide(current); }
}
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') { e.preventDefault(); changeSlide(1); }
  else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); changeSlide(-1); }
  else if (e.key === 's' || e.key === 'S') {
    const slide = document.getElementById('s' + current);
    const steps = slide.querySelectorAll('.step:not(.revealed)');
    if (steps.length > 0) steps[0].classList.add('revealed');
  }
});

/* ============================= Enhancement 1: Animated TM Machine ============================= */
var tm_mach_tape = [];
var tm_mach_head = 2;
var tm_mach_state = 'q0';
var tm_mach_stepIdx = 0;
var tm_mach_timers = [];
var tm_mach_running = false;
var tm_mach_steps = [
  // step 0: initial
  { tape: ['B','B','0','1','1','0','1','B','B','B','B'], head: 2, state: 'q0', action: '' },
  { tape: ['B','B','X','1','1','0','1','B','B','B','B'], head: 3, state: 'q0', action: 'Read 0: write X, move R' },
  { tape: ['B','B','X','Y','1','0','1','B','B','B','B'], head: 4, state: 'q0', action: 'Read 1: write Y, move R' },
  { tape: ['B','B','X','Y','Y','0','1','B','B','B','B'], head: 5, state: 'q0', action: 'Read 1: write Y, move R' },
  { tape: ['B','B','X','Y','Y','X','1','B','B','B','B'], head: 6, state: 'q0', action: 'Read 0: write X, move R' },
  { tape: ['B','B','X','Y','Y','X','Y','B','B','B','B'], head: 7, state: 'q0', action: 'Read 1: write Y, move R' },
  { tape: ['B','B','X','Y','Y','X','Y','B','B','B','B'], head: 7, state: 'q_acc', action: 'Read B: ACCEPT!' }
];

function tm_mach_render() {
  var svg = document.getElementById('tm_mach_tape');
  svg.innerHTML = '';
  var s = tm_mach_steps[tm_mach_stepIdx];
  var cellW = 55, startX = 375 - 5.5 * cellW;
  for (var i = 0; i < 11; i++) {
    var x = startX + i * cellW;
    var isHead = (i === s.head);
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 20); r.setAttribute('width', cellW); r.setAttribute('height', 45);
    r.setAttribute('rx', 4); r.setAttribute('fill', '#1e293b');
    r.setAttribute('stroke', isHead ? '#fbbf24' : '#475569');
    r.setAttribute('stroke-width', isHead ? 2.5 : 1);
    svg.appendChild(r);
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x + cellW/2); t.setAttribute('y', 49); t.setAttribute('text-anchor', 'middle');
    t.setAttribute('font-family', 'monospace'); t.setAttribute('font-size', '18');
    var sym = s.tape[i];
    var col = '#e2e8f0';
    if (sym === 'X') col = '#67e8f9';
    else if (sym === 'Y') col = '#c4b5fd';
    else if (sym === 'B') col = '#64748b';
    t.setAttribute('fill', col); t.textContent = sym;
    svg.appendChild(t);
  }
  // dots
  var ld = document.createElementNS('http://www.w3.org/2000/svg','text');
  ld.setAttribute('x', startX - 14); ld.setAttribute('y', 49); ld.setAttribute('text-anchor','middle');
  ld.setAttribute('fill','#64748b'); ld.setAttribute('font-size','18'); ld.textContent = '...';
  svg.appendChild(ld);
  var rd = document.createElementNS('http://www.w3.org/2000/svg','text');
  rd.setAttribute('x', startX + 11*cellW + 14); rd.setAttribute('y', 49); rd.setAttribute('text-anchor','middle');
  rd.setAttribute('fill','#64748b'); rd.setAttribute('font-size','18'); rd.textContent = '...';
  svg.appendChild(rd);

  // Head arrow position
  var headX = startX + s.head * cellW + cellW/2;
  var headG = document.getElementById('tm_mach_head');
  headG.setAttribute('transform', 'translate(' + headX + ', 82)');
  // Connector
  document.getElementById('tm_mach_connector').setAttribute('x1', headX);
  document.getElementById('tm_mach_connector').setAttribute('x2', 375);
  document.getElementById('tm_mach_connector').setAttribute('y1', 95);

  // State
  var stText = document.getElementById('tm_mach_state_text');
  stText.textContent = 'State: ' + s.state;
  if (s.state === 'q_acc') {
    stText.setAttribute('fill', '#10b981');
    document.getElementById('tm_mach_fc_box').setAttribute('stroke', '#10b981');
  } else {
    stText.setAttribute('fill', '#93c5fd');
    document.getElementById('tm_mach_fc_box').setAttribute('stroke', '#475569');
  }
  document.getElementById('tm_mach_action_text').textContent = s.action;

  // Status
  var status = document.getElementById('tm_mach_status');
  if (tm_mach_stepIdx === 0) status.innerHTML = 'Demo: TM replaces 0&rarr;X and 1&rarr;Y, then accepts. Click Step or Run.';
  else if (s.state === 'q_acc') status.innerHTML = '<span style="color:#10b981; font-weight:bold;">ACCEPTED!</span> All input symbols replaced.';
  else status.textContent = 'Step ' + tm_mach_stepIdx + ' of ' + (tm_mach_steps.length - 1) + ': ' + s.action;

  var done = (tm_mach_stepIdx >= tm_mach_steps.length - 1);
  document.getElementById('tm_mach_step_btn').disabled = done;
  document.getElementById('tm_mach_run_btn').disabled = done || tm_mach_running;
}

function tm_mach_step() {
  if (tm_mach_stepIdx < tm_mach_steps.length - 1) {
    tm_mach_stepIdx++;
    tm_mach_render();
  }
}

function tm_mach_run() {
  if (tm_mach_running) return;
  tm_mach_running = true;
  function go() {
    if (tm_mach_stepIdx < tm_mach_steps.length - 1) {
      tm_mach_stepIdx++;
      tm_mach_render();
      tm_mach_timers.push(setTimeout(go, 600));
    } else {
      tm_mach_running = false;
      tm_mach_render();
    }
  }
  go();
}

function tm_mach_reset() {
  tm_mach_running = false;
  tm_mach_timers.forEach(function(t) { clearTimeout(t); });
  tm_mach_timers = [];
  tm_mach_stepIdx = 0;
  tm_mach_render();
}

/* ============================= Enhancement 2: TM Simulator for 0^n1^n ============================= */
var tm_sim_tape = [];
var tm_sim_headPos = 0;
var tm_sim_stateNow = 'q0';
var tm_sim_steps = [];
var tm_sim_stepIdx = 0;
var tm_sim_timers = [];
var tm_sim_running = false;
var tm_sim_loaded = false;

var tm_sim_transitions = {
  'q0,0': ['q1','X','R'], 'q0,Y': ['q3','Y','R'],
  'q1,0': ['q1','0','R'], 'q1,Y': ['q1','Y','R'], 'q1,1': ['q2','Y','L'],
  'q2,0': ['q2','0','L'], 'q2,Y': ['q2','Y','L'], 'q2,X': ['q0','X','R'],
  'q3,Y': ['q3','Y','R'], 'q3,B': ['q4','B','R']
};

var tm_sim_state_colors = { q0:'#3b82f6', q1:'#f59e0b', q2:'#8b5cf6', q3:'#10b981', q4:'#34d399' };
var tm_sim_state_descs = { q0:'Find next 0', q1:'Scan right for 1', q2:'Scan left to X', q3:'Verify all done', q4:'ACCEPT' };

function tm_sim_load() {
  var input = document.getElementById('tm_sim_input').value.trim();
  if (!/^[01]+$/.test(input) && input !== '') {
    document.getElementById('tm_sim_verdict').innerHTML = '<span style="color:#f87171;">Invalid input: only 0s and 1s allowed.</span>';
    return;
  }
  tm_sim_timers.forEach(function(t) { clearTimeout(t); });
  tm_sim_timers = [];
  tm_sim_running = false;

  // Build tape with blanks on each side
  var pad = 4;
  tm_sim_tape = [];
  for (var i = 0; i < pad; i++) tm_sim_tape.push('B');
  for (var i = 0; i < input.length; i++) tm_sim_tape.push(input[i]);
  for (var i = 0; i < pad + 2; i++) tm_sim_tape.push('B');

  var headStart = pad; // first input symbol
  // Precompute steps
  tm_sim_steps = [];
  var tape = tm_sim_tape.slice();
  var head = headStart;
  var state = 'q0';
  tm_sim_steps.push({ tape: tape.slice(), head: head, state: state, log: 'Initial configuration' });

  var maxSteps = 200;
  for (var step = 0; step < maxSteps; step++) {
    var sym = tape[head] || 'B';
    var key = state + ',' + sym;
    var tr = tm_sim_transitions[key];
    if (!tr) {
      // Halt
      var verdict = (state === 'q4') ? 'ACCEPT' : 'REJECT';
      tm_sim_steps[tm_sim_steps.length-1].verdict = verdict;
      break;
    }
    var newState = tr[0], writeSym = tr[1], dir = tr[2];
    var logLine = 'Step ' + (step+1) + ': state ' + state + ', read \'' + sym + '\', write \'' + writeSym + '\', move ' + dir + ' -> ' + newState;
    tape[head] = writeSym;
    head += (dir === 'R') ? 1 : -1;
    if (head < 0) { tape.unshift('B'); head = 0; }
    if (head >= tape.length) tape.push('B');
    state = newState;
    tm_sim_steps.push({ tape: tape.slice(), head: head, state: state, log: logLine });
    if (state === 'q4') {
      tm_sim_steps[tm_sim_steps.length-1].verdict = 'ACCEPT';
      break;
    }
  }
  if (tm_sim_steps.length > 0 && !tm_sim_steps[tm_sim_steps.length-1].verdict) {
    tm_sim_steps[tm_sim_steps.length-1].verdict = 'LOOP (exceeded ' + maxSteps + ' steps)';
  }

  tm_sim_stepIdx = 0;
  tm_sim_loaded = true;
  document.getElementById('tm_sim_step_btn').disabled = false;
  document.getElementById('tm_sim_run_btn').disabled = false;
  document.getElementById('tm_sim_verdict').textContent = '';
  document.getElementById('tm_sim_log').innerHTML = '';
  tm_sim_render();
}

function tm_sim_render() {
  if (!tm_sim_loaded || tm_sim_steps.length === 0) return;
  var s = tm_sim_steps[tm_sim_stepIdx];
  // Draw tape SVG
  var svg = document.getElementById('tm_sim_svg');
  svg.innerHTML = '';
  var cellW = 50, numCells = 15;
  var centerCell = Math.floor(numCells / 2);
  var startIdx = s.head - centerCell;
  var totalW = numCells * cellW;
  var offsetX = (800 - totalW) / 2;

  for (var i = 0; i < numCells; i++) {
    var tapeIdx = startIdx + i;
    var sym = (tapeIdx >= 0 && tapeIdx < s.tape.length) ? s.tape[tapeIdx] : 'B';
    var x = offsetX + i * cellW;
    var isHead = (tapeIdx === s.head);

    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 2); r.setAttribute('width', cellW); r.setAttribute('height', 40);
    r.setAttribute('rx', 3); r.setAttribute('fill', isHead ? 'rgba(251,191,36,0.15)' : '#1e293b');
    r.setAttribute('stroke', isHead ? '#fbbf24' : '#475569'); r.setAttribute('stroke-width', isHead ? 2 : 1);
    svg.appendChild(r);

    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x + cellW/2); t.setAttribute('y', 28); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-family','monospace'); t.setAttribute('font-size','16');
    var col = '#e2e8f0';
    if (sym === 'X') col = '#67e8f9';
    else if (sym === 'Y') col = '#c4b5fd';
    else if (sym === 'B') col = '#64748b';
    t.setAttribute('fill', col); t.textContent = sym;
    svg.appendChild(t);
  }

  // Head triangle below tape
  var headScreenX = offsetX + centerCell * cellW + cellW/2;
  var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  tri.setAttribute('points', (headScreenX-8)+',58 '+(headScreenX+8)+',58 '+headScreenX+',46');
  tri.setAttribute('fill', tm_sim_state_colors[s.state] || '#fbbf24');
  svg.appendChild(tri);

  // State display
  var stDisp = document.getElementById('tm_sim_state_display');
  stDisp.textContent = s.state;
  stDisp.style.background = (tm_sim_state_colors[s.state] || '#334155') + '33';
  stDisp.style.color = tm_sim_state_colors[s.state] || '#e2e8f0';
  document.getElementById('tm_sim_state_desc').textContent = tm_sim_state_descs[s.state] || '';

  // Step counter
  document.getElementById('tm_sim_step_counter').textContent = 'Step ' + tm_sim_stepIdx + ' of ' + (tm_sim_steps.length - 1);

  // Verdict
  if (s.verdict) {
    var vDiv = document.getElementById('tm_sim_verdict');
    if (s.verdict === 'ACCEPT') vDiv.innerHTML = '<span style="color:#10b981;">ACCEPTED - Input is in {0^n 1^n}</span>';
    else if (s.verdict === 'REJECT') vDiv.innerHTML = '<span style="color:#ef4444;">REJECTED - Input is NOT in {0^n 1^n}</span>';
    else vDiv.innerHTML = '<span style="color:#f59e0b;">' + s.verdict + '</span>';
  }

  var done = (tm_sim_stepIdx >= tm_sim_steps.length - 1);
  document.getElementById('tm_sim_step_btn').disabled = done;
  document.getElementById('tm_sim_run_btn').disabled = done || tm_sim_running;
}

function tm_sim_step() {
  if (tm_sim_stepIdx < tm_sim_steps.length - 1) {
    tm_sim_stepIdx++;
    tm_sim_render();
    // Add to log
    var s = tm_sim_steps[tm_sim_stepIdx];
    if (s.log && s.log !== 'Initial configuration') {
      var logDiv = document.getElementById('tm_sim_log');
      logDiv.innerHTML += s.log + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  }
}

function tm_sim_run() {
  if (tm_sim_running) return;
  tm_sim_running = true;
  var speed = document.getElementById('tm_sim_speed');
  function go() {
    var delay = 600 - (parseInt(speed.value) - 1) * 55;
    if (tm_sim_stepIdx < tm_sim_steps.length - 1) {
      tm_sim_step();
      tm_sim_timers.push(setTimeout(go, delay));
    } else {
      tm_sim_running = false;
      tm_sim_render();
    }
  }
  go();
}

function tm_sim_reset() {
  tm_sim_running = false;
  tm_sim_timers.forEach(function(t) { clearTimeout(t); });
  tm_sim_timers = [];
  if (tm_sim_loaded) {
    tm_sim_stepIdx = 0;
    document.getElementById('tm_sim_verdict').textContent = '';
    document.getElementById('tm_sim_log').innerHTML = '';
    document.getElementById('tm_sim_step_btn').disabled = false;
    document.getElementById('tm_sim_run_btn').disabled = false;
    tm_sim_render();
  }
}

/* ============================= Enhancement 3: Binary Increment Simulator ============================= */
var tm_inc_tape = [];
var tm_inc_headPos = 0;
var tm_inc_steps = [];
var tm_inc_stepIdx = 0;
var tm_inc_timers = [];
var tm_inc_running = false;
var tm_inc_loaded = false;
var tm_inc_inputStr = '';

function tm_inc_load() {
  var input = document.getElementById('tm_inc_input').value.trim();
  if (!/^[01]+$/.test(input)) {
    document.getElementById('tm_inc_result').innerHTML = '<span style="color:#f87171;">Invalid: only 0s and 1s, non-empty.</span>';
    return;
  }
  tm_inc_timers.forEach(function(t) { clearTimeout(t); });
  tm_inc_timers = [];
  tm_inc_running = false;
  tm_inc_inputStr = input;

  // Build tape: B + input + B
  var tape = ['B'];
  for (var i = 0; i < input.length; i++) tape.push(input[i]);
  tape.push('B');

  var head = input.length; // rightmost bit (1-indexed in tape because of leading B)

  // Precompute
  tm_inc_steps = [];
  tm_inc_steps.push({ tape: tape.slice(), head: head, state: 'q0' });

  var state = 'q0';
  var maxS = 50;
  for (var st = 0; st < maxS; st++) {
    var sym = tape[head];
    if (state === 'q0') {
      if (sym === '0') {
        tape[head] = '1';
        tm_inc_steps.push({ tape: tape.slice(), head: head, state: 'qf', flash: 'green' });
        break;
      } else if (sym === '1') {
        tape[head] = '0';
        tm_inc_steps.push({ tape: tape.slice(), head: head, state: 'q0', flash: 'red' });
        head--;
        if (head < 0) { tape.unshift('B'); head = 0; }
      } else { // B
        tape[head] = '1';
        tm_inc_steps.push({ tape: tape.slice(), head: head, state: 'qf', flash: 'green' });
        break;
      }
    } else {
      break;
    }
  }

  tm_inc_stepIdx = 0;
  tm_inc_loaded = true;
  document.getElementById('tm_inc_step_btn').disabled = false;
  document.getElementById('tm_inc_run_btn').disabled = false;
  document.getElementById('tm_inc_result').textContent = '';
  tm_inc_render();
}

function tm_inc_render() {
  if (!tm_inc_loaded) return;
  var s = tm_inc_steps[tm_inc_stepIdx];
  var svg = document.getElementById('tm_inc_svg');
  svg.innerHTML = '';
  var cellW = 50, numCells = 9;
  var centerCell = Math.floor(numCells / 2);
  var startIdx = s.head - centerCell;
  var totalW = numCells * cellW;
  var offsetX = (450 - totalW) / 2;

  for (var i = 0; i < numCells; i++) {
    var tapeIdx = startIdx + i;
    var sym = (tapeIdx >= 0 && tapeIdx < s.tape.length) ? s.tape[tapeIdx] : 'B';
    var x = offsetX + i * cellW;
    var isHead = (tapeIdx === s.head);

    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 2); r.setAttribute('width', cellW); r.setAttribute('height', 36);
    r.setAttribute('rx', 3); r.setAttribute('fill', isHead ? 'rgba(251,191,36,0.15)' : '#1e293b');
    r.setAttribute('stroke', isHead ? '#fbbf24' : '#475569'); r.setAttribute('stroke-width', isHead ? 2 : 1);
    svg.appendChild(r);

    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x + cellW/2); t.setAttribute('y', 26); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-family','monospace'); t.setAttribute('font-size','15');
    var col = sym === 'B' ? '#64748b' : '#e2e8f0';
    t.setAttribute('fill', col); t.textContent = sym;
    svg.appendChild(t);
  }

  // Head triangle
  var headScreenX = offsetX + centerCell * cellW + cellW/2;
  var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  tri.setAttribute('points', (headScreenX-7)+',52 '+(headScreenX+7)+',52 '+headScreenX+',42');
  tri.setAttribute('fill', s.state === 'qf' ? '#10b981' : '#fbbf24');
  svg.appendChild(tri);

  // State label
  document.getElementById('tm_inc_state_label').textContent = 'State: ' + s.state;

  // Result on completion
  if (s.state === 'qf') {
    // Extract result from tape (non-B symbols)
    var bits = [];
    for (var i = 0; i < s.tape.length; i++) {
      if (s.tape[i] !== 'B') bits.push(s.tape[i]);
    }
    var resultStr = bits.join('');
    var inputDec = parseInt(tm_inc_inputStr, 2);
    var outputDec = parseInt(resultStr, 2);
    document.getElementById('tm_inc_result').innerHTML =
      '<span style="color:#10b981;">Input: ' + tm_inc_inputStr + ' (decimal ' + inputDec + ') &rarr; Output: ' + resultStr + ' (decimal ' + outputDec + ')</span>';
  }

  var done = (tm_inc_stepIdx >= tm_inc_steps.length - 1);
  document.getElementById('tm_inc_step_btn').disabled = done;
  document.getElementById('tm_inc_run_btn').disabled = done || tm_inc_running;
}

function tm_inc_step() {
  if (tm_inc_stepIdx < tm_inc_steps.length - 1) {
    tm_inc_stepIdx++;
    tm_inc_render();
  }
}

function tm_inc_run() {
  if (tm_inc_running) return;
  tm_inc_running = true;
  function go() {
    if (tm_inc_stepIdx < tm_inc_steps.length - 1) {
      tm_inc_step();
      tm_inc_timers.push(setTimeout(go, 500));
    } else {
      tm_inc_running = false;
      tm_inc_render();
    }
  }
  go();
}

function tm_inc_reset() {
  tm_inc_running = false;
  tm_inc_timers.forEach(function(t) { clearTimeout(t); });
  tm_inc_timers = [];
  if (tm_inc_loaded) {
    tm_inc_stepIdx = 0;
    document.getElementById('tm_inc_result').textContent = '';
    document.getElementById('tm_inc_step_btn').disabled = false;
    document.getElementById('tm_inc_run_btn').disabled = false;
    tm_inc_render();
  }
}

/* ============================= Enhancement 4: Transition Explorer ============================= */
var tm_trx_timers = [];
var tm_trx_playing = false;

var tm_trx_examples = [
  { readSym:'0', writeSym:'X', dir:'R', fromState:'q1', toState:'q2',
    tape:['Y','0','1','X','B','B','B'], headIdx:1,
    narration:'Read 0 -> Write X -> Move Right -> Now in q2' },
  { readSym:'1', writeSym:'Y', dir:'L', fromState:'q2', toState:'q3',
    tape:['X','0','1','Y','B','B','B'], headIdx:2,
    narration:'Read 1 -> Write Y -> Move Left -> Now in q3' },
  { readSym:'B', writeSym:'B', dir:'R', fromState:'q0', toState:'q1',
    tape:['B','B','0','1','1','B','B'], headIdx:0,
    narration:'Read B -> Write B -> Move Right -> Now in q1' },
  { readSym:'X', writeSym:'X', dir:'R', fromState:'q3', toState:'q3',
    tape:['0','X','Y','1','B','B','B'], headIdx:1,
    narration:'Read X -> Write X -> Move Right -> Stay in q3' }
];

function tm_trx_drawTape(tape, headIdx, highlight, stateLabel) {
  var svg = document.getElementById('tm_trx_svg');
  svg.innerHTML = '';
  var cellW = 55, numCells = 7;
  var totalW = numCells * cellW;
  var offsetX = (500 - totalW) / 2;

  for (var i = 0; i < numCells; i++) {
    var sym = tape[i] || 'B';
    var x = offsetX + i * cellW;
    var isHead = (i === headIdx);

    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 2); r.setAttribute('width', cellW); r.setAttribute('height', 36);
    r.setAttribute('rx', 3); r.setAttribute('fill', (isHead && highlight) ? 'rgba(251,191,36,0.2)' : '#0f172a');
    r.setAttribute('stroke', isHead ? '#fbbf24' : '#475569'); r.setAttribute('stroke-width', isHead ? 2 : 1);
    svg.appendChild(r);

    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x + cellW/2); t.setAttribute('y', 26); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-family','monospace'); t.setAttribute('font-size','15');
    var col = '#e2e8f0';
    if (sym === 'X') col = '#67e8f9';
    else if (sym === 'Y') col = '#c4b5fd';
    else if (sym === 'B') col = '#64748b';
    t.setAttribute('fill', col); t.textContent = sym;
    svg.appendChild(t);
  }

  // Head indicator
  var headX = offsetX + headIdx * cellW + cellW/2;
  var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  tri.setAttribute('points', (headX-7)+',52 '+(headX+7)+',52 '+headX+',42');
  tri.setAttribute('fill', '#fbbf24');
  svg.appendChild(tri);

  // State label
  if (stateLabel) {
    var st = document.createElementNS('http://www.w3.org/2000/svg','text');
    st.setAttribute('x', headX); st.setAttribute('y', 58); st.setAttribute('text-anchor','middle');
    st.setAttribute('font-family','monospace'); st.setAttribute('font-size','10'); st.setAttribute('fill','#94a3b8');
    st.textContent = stateLabel;
    svg.appendChild(st);
  }
}

function tm_trx_play(idx) {
  if (tm_trx_playing) return;
  tm_trx_playing = true;
  tm_trx_timers.forEach(function(t) { clearTimeout(t); });
  tm_trx_timers = [];

  var ex = tm_trx_examples[idx];
  var tape = ex.tape.slice();
  var head = ex.headIdx;
  var narr = document.getElementById('tm_trx_narration');

  // Highlight button
  var btns = document.querySelectorAll('.tm_trx-buttons button');
  btns.forEach(function(b) { b.classList.remove('active'); });
  btns[idx].classList.add('active');

  // Phase 1: Show before state
  tm_trx_drawTape(tape, head, true, ex.fromState);
  narr.textContent = 'Reading \'' + ex.readSym + '\' in state ' + ex.fromState + '...';

  // Phase 2: Write
  tm_trx_timers.push(setTimeout(function() {
    tape[head] = ex.writeSym;
    tm_trx_drawTape(tape, head, true, ex.fromState);
    narr.textContent = 'Write \'' + ex.writeSym + '\' over \'' + ex.readSym + '\'...';
  }, 600));

  // Phase 3: Move head
  tm_trx_timers.push(setTimeout(function() {
    var newHead = head + (ex.dir === 'R' ? 1 : -1);
    if (newHead < 0) newHead = 0;
    if (newHead >= tape.length) newHead = tape.length - 1;
    tm_trx_drawTape(tape, newHead, false, ex.toState);
    narr.textContent = ex.narration;
    tm_trx_playing = false;
  }, 1200));
}

// Initial empty state for explorer
function tm_trx_init() {
  tm_trx_drawTape(['B','B','B','B','B','B','B'], 3, false, '');
}

/* ============================= Enhancement 5: Challenge Quiz ============================= */
var tm_q1_pool = [
  {
    q: 'In a TM, &delta;(q1, 0) = (q2, X, R). What happens to the tape cell?',
    opts: ['The cell becomes blank (B)', '0 is replaced by X', 'X is replaced by 0'],
    correct: 1,
    explain: 'The transition writes X over the 0 that was read, then moves right.'
  },
  {
    q: 'True or False: A Turing Machine\'s tape is infinite in only one direction.',
    opts: ['True', 'False'],
    correct: 1,
    explain: 'Standard TMs have tape infinite in both directions (though one-way infinite is equivalent in power).'
  },
  {
    q: 'The TM for 0<sup>n</sup>1<sup>n</sup> is in state q1 scanning right. It reads a Y. What does it do?',
    opts: ['Reject immediately', 'Skip it (write Y, move R, stay in q1)', 'Write X and move left'],
    correct: 1,
    explain: 'In q1, the TM skips over both 0s and Ys while scanning right to find a 1.'
  },
  {
    q: 'Can a TM recognize { a<sup>n</sup>b<sup>n</sup>c<sup>n</sup> | n &ge; 1 }?',
    opts: ['No, it requires a more powerful model', 'Yes'],
    correct: 1,
    explain: 'Unlike PDAs, TMs can count three things by marking symbols. Use zig-zag: mark one a, one b, one c per pass.'
  },
  {
    q: 'A language L is decidable. What can we say about its complement?',
    opts: ['The complement is also decidable', 'The complement is RE but not decidable', 'Nothing can be determined'],
    correct: 0,
    explain: 'Decidable (recursive) languages are closed under complement. Just swap accept/reject in the TM.'
  },
  {
    q: 'What is the key difference between "decidable" and "recognizable"?',
    opts: ['Decidable TMs always halt; recognizable TMs may loop on non-members', 'Recognizable TMs are more powerful', 'Decidable TMs can only handle regular languages'],
    correct: 0,
    explain: 'A decidable TM gives YES or NO for every input. A recognizable TM says YES for members but might loop forever on non-members.'
  }
];

var tm_q1_selected = [];
var tm_q1_current = 0;
var tm_q1_score = 0;
var tm_q1_timers = [];

function tm_q1_shuffle(arr) {
  var a = arr.slice();
  for (var i = a.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
  }
  return a;
}

function tm_q1_init() {
  tm_q1_timers.forEach(function(t) { clearTimeout(t); });
  tm_q1_timers = [];
  // Pick 3 random from pool of 6
  var indices = tm_q1_shuffle([0,1,2,3,4,5]);
  tm_q1_selected = [tm_q1_pool[indices[0]], tm_q1_pool[indices[1]], tm_q1_pool[indices[2]]];
  tm_q1_current = 0;
  tm_q1_score = 0;
  document.getElementById('tm_q1_retry').style.display = 'none';
  tm_q1_showQuestion();
}

function tm_q1_showQuestion() {
  var container = document.getElementById('tm_q1_container');
  var progress = document.getElementById('tm_q1_progress');

  if (tm_q1_current >= 3) {
    // Show final score
    var emoji = tm_q1_score === 3 ? 'Perfect!' : (tm_q1_score >= 2 ? 'Great job!' : 'Keep studying!');
    container.innerHTML = '<div class="tm_q1-score" style="color:' + (tm_q1_score >= 2 ? '#10b981' : '#f59e0b') + ';">' +
      'Score: ' + tm_q1_score + ' / 3 &mdash; ' + emoji + '</div>';
    progress.textContent = 'Quiz Complete';
    document.getElementById('tm_q1_retry').style.display = 'block';
    return;
  }

  progress.textContent = 'Question ' + (tm_q1_current + 1) + ' of 3';
  var qObj = tm_q1_selected[tm_q1_current];

  var html = '<div class="tm_q1-question"><h3>' + qObj.q + '</h3><div class="tm_q1-options">';
  for (var i = 0; i < qObj.opts.length; i++) {
    html += '<button onclick="tm_q1_answer(' + i + ', ' + qObj.correct + ')" id="tm_q1_opt_' + i + '">' + qObj.opts[i] + '</button>';
  }
  html += '</div><div class="tm_q1-explanation" id="tm_q1_explain">' + qObj.explain + '</div></div>';
  container.innerHTML = html;
}

function tm_q1_answer(chosen, correct) {
  // Disable all buttons
  var qObj = tm_q1_selected[tm_q1_current];
  for (var i = 0; i < qObj.opts.length; i++) {
    var btn = document.getElementById('tm_q1_opt_' + i);
    btn.disabled = true;
    if (i === correct) btn.classList.add('correct');
    if (i === chosen && chosen !== correct) btn.classList.add('wrong');
  }
  if (chosen === correct) tm_q1_score++;
  document.getElementById('tm_q1_explain').style.display = 'block';

  // Auto-advance
  tm_q1_timers.push(setTimeout(function() {
    tm_q1_current++;
    tm_q1_showQuestion();
  }, 2500));
}

/* ============================= Enhancement 6: PDA Failure Demo (slide 3) ============================= */
var tm_pda_timers = [];
var tm_pda_running = false;

var tm_pda_scenarios = [
  {
    name: 'aabbcc',
    input: ['a','a','b','b','c','c'],
    steps: [
      { action:'push', sym:'a', stackAfter:['$','a'], readIdx:0, msg:'Push a for first a' },
      { action:'push', sym:'a', stackAfter:['$','a','a'], readIdx:1, msg:'Push a for second a' },
      { action:'pop', sym:'a', stackAfter:['$','a'], readIdx:2, msg:'Pop a to match first b' },
      { action:'pop', sym:'a', stackAfter:['$'], readIdx:3, msg:'Pop a to match second b' },
      { action:'fail', sym:'', stackAfter:['$'], readIdx:4, msg:'<span style="color:#ef4444;font-weight:bold;">FAIL!</span> Stack used up matching a\'s and b\'s -- no memory left for c\'s!' }
    ]
  },
  {
    name: '011011',
    input: ['0','1','1','0','1','1'],
    steps: [
      { action:'push', sym:'0', stackAfter:['$','0'], readIdx:0, msg:'Push 0' },
      { action:'push', sym:'1', stackAfter:['$','0','1'], readIdx:1, msg:'Push 1' },
      { action:'push', sym:'1', stackAfter:['$','0','1','1'], readIdx:2, msg:'Push 1' },
      { action:'pop', sym:'1', stackAfter:['$','0','1'], readIdx:3, msg:'Pop: got 1, but need 0!' },
      { action:'fail', sym:'', stackAfter:['$','0','1'], readIdx:3, msg:'<span style="color:#ef4444;font-weight:bold;">FAIL!</span> Stack is LIFO -- pops in reverse! Got 1,1,0 but needed 0,1,1' }
    ]
  },
  {
    name: 'aaaa',
    input: ['a','a','a','a'],
    steps: [
      { action:'push', sym:'a', stackAfter:['$','a'], readIdx:0, msg:'Push a (count 1)' },
      { action:'push', sym:'a', stackAfter:['$','a','a'], readIdx:1, msg:'Push a (count 2)' },
      { action:'push', sym:'a', stackAfter:['$','a','a','a'], readIdx:2, msg:'Push a (count 3)' },
      { action:'push', sym:'a', stackAfter:['$','a','a','a','a'], readIdx:3, msg:'Push a (count 4). Stack holds 4. Is 4 a perfect square? Need arithmetic!' },
      { action:'fail', sym:'', stackAfter:['$','a','a','a','a'], readIdx:3, msg:'<span style="color:#ef4444;font-weight:bold;">FAIL!</span> Requires arithmetic -- beyond stack\'s LIFO counting.' }
    ]
  }
];

function tm_pda_renderStack(stackArr, highlightTop, highlightClass) {
  var el = document.getElementById('tm_pda_stack');
  el.innerHTML = '';
  for (var i = 0; i < stackArr.length; i++) {
    var cell = document.createElement('div');
    cell.className = 'tm_pda-cell';
    if (i === stackArr.length - 1 && highlightTop) cell.classList.add(highlightClass);
    cell.textContent = stackArr[i];
    el.appendChild(cell);
  }
}

function tm_pda_renderTape(input, readIdx, failIdx) {
  var el = document.getElementById('tm_pda_tape');
  el.innerHTML = '';
  for (var i = 0; i < input.length; i++) {
    var cell = document.createElement('div');
    cell.className = 'tm_pda-input-cell';
    if (i === readIdx) cell.classList.add('reading');
    else if (i < readIdx) cell.classList.add('done');
    cell.textContent = input[i];
    el.appendChild(cell);
  }
}

function tm_pda_run(idx) {
  if (tm_pda_running) return;
  tm_pda_running = true;
  tm_pda_timers.forEach(function(t) { clearTimeout(t); });
  tm_pda_timers = [];

  var btns = document.querySelectorAll('.tm_pda-buttons button');
  btns.forEach(function(b) { b.classList.remove('active'); });
  btns[idx].classList.add('active');

  var sc = tm_pda_scenarios[idx];
  var msg = document.getElementById('tm_pda_msg');

  // Initial state
  tm_pda_renderStack(['$'], false, '');
  tm_pda_renderTape(sc.input, -1);
  msg.innerHTML = 'Processing ' + sc.input.join('') + '...';

  sc.steps.forEach(function(step, i) {
    tm_pda_timers.push(setTimeout(function() {
      tm_pda_renderTape(sc.input, step.readIdx, step.action === 'fail' ? step.readIdx : -1);
      var hlClass = step.action === 'push' ? 'push' : (step.action === 'pop' ? 'pop' : 'fail');
      tm_pda_renderStack(step.stackAfter, true, hlClass);
      msg.innerHTML = step.msg;
      if (i === sc.steps.length - 1) tm_pda_running = false;
    }, (i + 1) * 700));
  });
}

/* ============================= Enhancement 7: PDA vs TM Comparison (slide 6) ============================= */
var tm_cmp_timers = [];
var tm_cmp_running = false;

var tm_cmp_pda_steps = [
  { input: ['a','a','b','b','c','c'], readIdx: 0, stack: ['$','a'], headR: 0, msg: 'PDA: push a' },
  { input: ['a','a','b','b','c','c'], readIdx: 1, stack: ['$','a','a'], headR: 1, msg: 'PDA: push a' },
  { input: ['a','a','b','b','c','c'], readIdx: 2, stack: ['$','a'], headR: 2, msg: 'PDA: pop a for b' },
  { input: ['a','a','b','b','c','c'], readIdx: 3, stack: ['$'], headR: 3, msg: 'PDA: pop a for b' },
  { input: ['a','a','b','b','c','c'], readIdx: 4, stack: ['$'], headR: 4, msg: 'PDA: reach c -- stack empty!', fail: true }
];

var tm_cmp_tm_steps = [
  { tape: ['a','a','b','b','c','c','B','B'], head: 0, msg: 'TM: mark a with X', write: 'X' },
  { tape: ['X','a','b','b','c','c','B','B'], head: 2, msg: 'TM: scan right, mark b with Y', write: 'Y' },
  { tape: ['X','a','Y','b','c','c','B','B'], head: 4, msg: 'TM: scan right, mark c with Z', write: 'Z' },
  { tape: ['X','a','Y','b','Z','c','B','B'], head: 1, msg: 'TM: scan left, mark next a with X', write: 'X' },
  { tape: ['X','X','Y','b','Z','c','B','B'], head: 3, msg: 'TM: scan right, mark b with Y', write: 'Y' },
  { tape: ['X','X','Y','Y','Z','c','B','B'], head: 5, msg: 'TM: scan right, mark c with Z', write: 'Z' },
  { tape: ['X','X','Y','Y','Z','Z','B','B'], head: 0, msg: 'TM: all matched!', accept: true }
];

function tm_cmp_drawPDA(step) {
  var svg = document.getElementById('tm_cmp_pda_svg');
  svg.innerHTML = '';
  // Input tape
  var cellW = 30, startX = 10;
  for (var i = 0; i < 6; i++) {
    var x = startX + i * cellW;
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 5); r.setAttribute('width', cellW); r.setAttribute('height', 24);
    r.setAttribute('rx', 2); r.setAttribute('fill', i === step.readIdx ? 'rgba(251,191,36,0.15)' : '#0f172a');
    r.setAttribute('stroke', i === step.readIdx ? '#fbbf24' : '#475569'); r.setAttribute('stroke-width', 1);
    svg.appendChild(r);
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x+cellW/2); t.setAttribute('y', 22); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-size','12'); t.setAttribute('font-family','monospace');
    t.setAttribute('fill', i < step.readIdx ? '#475569' : '#e2e8f0');
    t.textContent = step.input[i];
    svg.appendChild(t);
  }
  // Arrow
  var ax = startX + 6*cellW + 8;
  var arr = document.createElementNS('http://www.w3.org/2000/svg','text');
  arr.setAttribute('x', ax); arr.setAttribute('y', 22); arr.setAttribute('font-size','14'); arr.setAttribute('fill','#64748b');
  arr.textContent = '\u2192'; svg.appendChild(arr);
  // Stack
  var stackX = 195, stackW = 30;
  for (var i = 0; i < step.stack.length; i++) {
    var y = 110 - i * 22;
    var r2 = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r2.setAttribute('x', stackX); r2.setAttribute('y', y); r2.setAttribute('width', stackW); r2.setAttribute('height', 20);
    r2.setAttribute('rx', 2);
    r2.setAttribute('fill', (i === step.stack.length-1 && !step.fail) ? 'rgba(139,92,246,0.2)' : '#0f172a');
    r2.setAttribute('stroke', step.fail ? '#ef4444' : '#475569'); r2.setAttribute('stroke-width', 1);
    svg.appendChild(r2);
    var t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
    t2.setAttribute('x', stackX+stackW/2); t2.setAttribute('y', y+14); t2.setAttribute('text-anchor','middle');
    t2.setAttribute('font-size','11'); t2.setAttribute('font-family','monospace');
    t2.setAttribute('fill', step.fail ? '#f87171' : '#c4b5fd');
    t2.textContent = step.stack[i]; svg.appendChild(t2);
  }
  if (step.fail) {
    var ft = document.createElementNS('http://www.w3.org/2000/svg','text');
    ft.setAttribute('x', 115); ft.setAttribute('y', 55); ft.setAttribute('text-anchor','middle');
    ft.setAttribute('font-size','20'); ft.setAttribute('fill','#ef4444'); ft.setAttribute('font-weight','bold');
    ft.textContent = '\u2717 FAIL'; svg.appendChild(ft);
  }
}

function tm_cmp_drawTM(step) {
  var svg = document.getElementById('tm_cmp_tm_svg');
  svg.innerHTML = '';
  var cellW = 26, startX = 5;
  for (var i = 0; i < 8; i++) {
    var x = startX + i * cellW;
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 20); r.setAttribute('width', cellW); r.setAttribute('height', 24);
    r.setAttribute('rx', 2); r.setAttribute('fill', i === step.head ? 'rgba(251,191,36,0.15)' : '#0f172a');
    r.setAttribute('stroke', i === step.head ? '#fbbf24' : '#475569'); r.setAttribute('stroke-width', 1);
    svg.appendChild(r);
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x+cellW/2); t.setAttribute('y', 37); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-size','11'); t.setAttribute('font-family','monospace');
    var sym = step.tape[i];
    var col = '#e2e8f0';
    if (sym === 'X') col = '#67e8f9';
    else if (sym === 'Y') col = '#c4b5fd';
    else if (sym === 'Z') col = '#fbbf24';
    else if (sym === 'B') col = '#64748b';
    t.setAttribute('fill', col); t.textContent = sym;
    svg.appendChild(t);
  }
  // Head triangle
  var hx = startX + step.head * cellW + cellW/2;
  var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  tri.setAttribute('points', (hx-6)+',18 '+(hx+6)+',18 '+hx+',10');
  tri.setAttribute('fill', '#fbbf24'); svg.appendChild(tri);
  // Arrows showing bidirectional
  var arr = document.createElementNS('http://www.w3.org/2000/svg','text');
  arr.setAttribute('x', hx); arr.setAttribute('y', 8); arr.setAttribute('text-anchor','middle');
  arr.setAttribute('font-size','10'); arr.setAttribute('fill','#64748b');
  arr.textContent = '\u2190\u2192'; svg.appendChild(arr);
  if (step.accept) {
    var at = document.createElementNS('http://www.w3.org/2000/svg','text');
    at.setAttribute('x', 115); at.setAttribute('y', 75); at.setAttribute('text-anchor','middle');
    at.setAttribute('font-size','18'); at.setAttribute('fill','#10b981'); at.setAttribute('font-weight','bold');
    at.textContent = '\u2713 ACCEPT'; svg.appendChild(at);
  }
}

function tm_cmp_run() {
  if (tm_cmp_running) return;
  tm_cmp_running = true;
  tm_cmp_timers.forEach(function(t) { clearTimeout(t); });
  tm_cmp_timers = [];
  document.getElementById('tm_cmp_btn').disabled = true;
  document.getElementById('tm_cmp_pda_side').classList.remove('fail','pass');
  document.getElementById('tm_cmp_tm_side').classList.remove('fail','pass');

  var maxSteps = Math.max(tm_cmp_pda_steps.length, tm_cmp_tm_steps.length);
  for (var i = 0; i < maxSteps; i++) {
    (function(idx) {
      tm_cmp_timers.push(setTimeout(function() {
        if (idx < tm_cmp_pda_steps.length) {
          tm_cmp_drawPDA(tm_cmp_pda_steps[idx]);
          if (tm_cmp_pda_steps[idx].fail) document.getElementById('tm_cmp_pda_side').classList.add('fail');
        }
        if (idx < tm_cmp_tm_steps.length) {
          tm_cmp_drawTM(tm_cmp_tm_steps[idx]);
          if (tm_cmp_tm_steps[idx].accept) document.getElementById('tm_cmp_tm_side').classList.add('pass');
        }
        document.getElementById('tm_cmp_step').textContent = 'Step ' + (idx+1) + ' of ' + maxSteps;
        if (idx === maxSteps - 1) {
          tm_cmp_running = false;
          document.getElementById('tm_cmp_btn').disabled = false;
        }
      }, idx * 500));
    })(i);
  }
}

function tm_cmp_init() {
  tm_cmp_drawPDA({ input:['a','a','b','b','c','c'], readIdx:-1, stack:['$'], headR:-1 });
  tm_cmp_drawTM({ tape:['a','a','b','b','c','c','B','B'], head:0 });
}

/* ============================= Enhancement 8: ID Transition Explorer (slide 9) ============================= */
var tm_id_timers = [];
var tm_id_playing = false;

var tm_id_examples = [
  { before: {tape:['0','1','1','0','B','B','B','B'], head:1, state:'q\u2081'},
    after:  {tape:['0','X','1','0','B','B','B','B'], head:2, state:'q\u2082'},
    desc: 'Read 1, write X, move R', writeIdx: 1,
    idBefore: '0 <span class="changed">q\u2081</span> 110', idAfter: '0X <span class="changed">q\u2082</span> 10' },
  { before: {tape:['0','1','1','0','B','B','B','B'], head:2, state:'q\u2083'},
    after:  {tape:['0','1','Y','0','B','B','B','B'], head:1, state:'q\u2084'},
    desc: 'Read 1, write Y, move L', writeIdx: 2,
    idBefore: '01 <span class="changed">q\u2083</span> 10', idAfter: '0 <span class="changed">q\u2084</span> 1Y0' },
  { before: {tape:['0','1','1','B','B','B','B','B'], head:0, state:'q\u2080'},
    after:  {tape:['X','1','1','B','B','B','B','B'], head:1, state:'q\u2081'},
    desc: 'Read 0, write X, move R', writeIdx: 0,
    idBefore: '<span class="changed">q\u2080</span> 011', idAfter: 'X <span class="changed">q\u2081</span> 11' },
  { before: {tape:['X','Y','Y','B','B','B','B','B'], head:2, state:'q\u2083'},
    after:  {tape:['X','Y','Y','B','B','B','B','B'], head:3, state:'q\u2080'},
    desc: 'Read Y, write Y, move R', writeIdx: 2,
    idBefore: 'XY <span class="changed">q\u2083</span> YB', idAfter: 'XYY <span class="changed">q\u2080</span> B' }
];

function tm_id_drawTape(tape, head, stateLabel, writeFlash) {
  var svg = document.getElementById('tm_id_svg');
  svg.innerHTML = '';
  var cellW = 55, numCells = 8;
  var totalW = numCells * cellW;
  var offsetX = (500 - totalW) / 2;
  for (var i = 0; i < numCells; i++) {
    var sym = tape[i] || 'B';
    var x = offsetX + i * cellW;
    var isHead = (i === head);
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', x); r.setAttribute('y', 2); r.setAttribute('width', cellW); r.setAttribute('height', 36);
    r.setAttribute('rx', 3);
    r.setAttribute('fill', (i === writeFlash) ? 'rgba(245,158,11,0.25)' : (isHead ? 'rgba(251,191,36,0.15)' : '#0f172a'));
    r.setAttribute('stroke', isHead ? '#fbbf24' : '#475569'); r.setAttribute('stroke-width', isHead ? 2 : 1);
    svg.appendChild(r);
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x+cellW/2); t.setAttribute('y', 26); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-family','monospace'); t.setAttribute('font-size','15');
    var col = '#e2e8f0';
    if (sym === 'X') col = '#67e8f9';
    else if (sym === 'Y') col = '#c4b5fd';
    else if (sym === 'B') col = '#64748b';
    if (i === writeFlash) col = '#f59e0b';
    t.setAttribute('fill', col); t.textContent = sym; svg.appendChild(t);
  }
  var hx = offsetX + head * cellW + cellW/2;
  var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  tri.setAttribute('points', (hx-7)+',52 '+(hx+7)+',52 '+hx+',42');
  tri.setAttribute('fill','#fbbf24'); svg.appendChild(tri);
  if (stateLabel) {
    var st = document.createElementNS('http://www.w3.org/2000/svg','text');
    st.setAttribute('x', hx); st.setAttribute('y', 66); st.setAttribute('text-anchor','middle');
    st.setAttribute('font-family','monospace'); st.setAttribute('font-size','11'); st.setAttribute('fill','#93c5fd');
    st.textContent = stateLabel; svg.appendChild(st);
  }
}

function tm_id_play(idx) {
  if (tm_id_playing) return;
  tm_id_playing = true;
  tm_id_timers.forEach(function(t) { clearTimeout(t); });
  tm_id_timers = [];

  var btns = document.querySelectorAll('.tm_id-buttons button');
  btns.forEach(function(b) { b.classList.remove('active'); });
  btns[idx].classList.add('active');

  var ex = tm_id_examples[idx];
  var textEl = document.getElementById('tm_id_text');

  // Phase 1: Before state
  tm_id_drawTape(ex.before.tape, ex.before.head, ex.before.state, -1);
  textEl.innerHTML = 'Before: ' + ex.idBefore;

  // Phase 2: Write (flash)
  tm_id_timers.push(setTimeout(function() {
    tm_id_drawTape(ex.after.tape, ex.before.head, ex.before.state, ex.writeIdx);
    textEl.innerHTML = ex.desc + '...';
  }, 600));

  // Phase 3: Move head
  tm_id_timers.push(setTimeout(function() {
    tm_id_drawTape(ex.after.tape, ex.after.head, ex.after.state, -1);
    textEl.innerHTML = 'After: ' + ex.idAfter;
    tm_id_playing = false;
  }, 1200));
}

function tm_id_init() {
  tm_id_drawTape(['B','B','B','B','B','B','B','B'], 3, '', -1);
}

/* ============================= Enhancement 9: Multi-Tape TM (slide 14) ============================= */
var tm_mt_stepIdx = 0;
var tm_mt_timers = [];
var tm_mt_running = false;

var tm_mt_steps = [
  { tape1:['B','a','b','a','B','B','B'], head1:1, tape2:['B','B','B','B','B','B','B'], head2:1, state:'q0', msg:'Initial: head on Tape 1 reads \'a\'' },
  { tape1:['B','a','b','a','B','B','B'], head1:2, tape2:['B','a','B','B','B','B','B'], head2:2, state:'q0', msg:'Read \'a\' from T1, write \'a\' to T2, both move R' },
  { tape1:['B','a','b','a','B','B','B'], head1:3, tape2:['B','a','b','B','B','B','B'], head2:3, state:'q0', msg:'Read \'b\' from T1, write \'b\' to T2, both move R' },
  { tape1:['B','a','b','a','B','B','B'], head1:4, tape2:['B','a','b','a','B','B','B'], head2:4, state:'q0', msg:'Read \'a\' from T1, write \'a\' to T2, both move R' },
  { tape1:['B','a','b','a','B','B','B'], head1:4, tape2:['B','a','b','a','B','B','B'], head2:4, state:'q_acc', msg:'Read B from T1 -- input copied! ACCEPT' }
];

function tm_mt_render() {
  var svg = document.getElementById('tm_mt_svg');
  svg.innerHTML = '';
  var s = tm_mt_steps[tm_mt_stepIdx];
  var cellW = 50, numCells = 7, startX = 30;
  var tapeColors = ['#93c5fd', '#34d399'];
  var tapes = [s.tape1, s.tape2];
  var heads = [s.head1, s.head2];
  var tapeLabels = ['Tape 1 (input)', 'Tape 2 (work)'];

  for (var t = 0; t < 2; t++) {
    var y = 20 + t * 80;
    // Label
    var lb = document.createElementNS('http://www.w3.org/2000/svg','text');
    lb.setAttribute('x', startX-5); lb.setAttribute('y', y+25); lb.setAttribute('text-anchor','end');
    lb.setAttribute('font-size','10'); lb.setAttribute('fill', tapeColors[t]); lb.setAttribute('font-family','system-ui');
    lb.textContent = tapeLabels[t]; svg.appendChild(lb);
    // Cells
    for (var i = 0; i < numCells; i++) {
      var x = startX + i * cellW;
      var isHead = (i === heads[t]);
      var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', x); r.setAttribute('y', y); r.setAttribute('width', cellW); r.setAttribute('height', 36);
      r.setAttribute('rx', 3); r.setAttribute('fill', isHead ? 'rgba(251,191,36,0.12)' : '#0f172a');
      r.setAttribute('stroke', isHead ? tapeColors[t] : '#475569'); r.setAttribute('stroke-width', isHead ? 2 : 1);
      svg.appendChild(r);
      var txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x', x+cellW/2); txt.setAttribute('y', y+24); txt.setAttribute('text-anchor','middle');
      txt.setAttribute('font-family','monospace'); txt.setAttribute('font-size','15');
      var sym = tapes[t][i];
      txt.setAttribute('fill', sym === 'B' ? '#64748b' : '#e2e8f0');
      txt.textContent = sym; svg.appendChild(txt);
    }
    // Head triangle
    var hx = startX + heads[t] * cellW + cellW/2;
    var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    tri.setAttribute('points', (hx-6)+','+(y+40)+' '+(hx+6)+','+(y+40)+' '+hx+','+(y+48));
    tri.setAttribute('fill', tapeColors[t]); svg.appendChild(tri);
  }

  // Finite Control box
  var boxX = startX + numCells * cellW + 30, boxY = 50;
  var bx = document.createElementNS('http://www.w3.org/2000/svg','rect');
  bx.setAttribute('x', boxX); bx.setAttribute('y', boxY); bx.setAttribute('width', 120); bx.setAttribute('height', 70);
  bx.setAttribute('rx', 10); bx.setAttribute('fill', '#1e293b');
  bx.setAttribute('stroke', s.state === 'q_acc' ? '#10b981' : '#475569'); bx.setAttribute('stroke-width', 2);
  svg.appendChild(bx);
  var fcLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
  fcLbl.setAttribute('x', boxX+60); fcLbl.setAttribute('y', boxY+25); fcLbl.setAttribute('text-anchor','middle');
  fcLbl.setAttribute('font-size','11'); fcLbl.setAttribute('fill','#94a3b8'); fcLbl.setAttribute('font-family','system-ui');
  fcLbl.textContent = 'Finite Control'; svg.appendChild(fcLbl);
  var stLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
  stLbl.setAttribute('x', boxX+60); stLbl.setAttribute('y', boxY+50); stLbl.setAttribute('text-anchor','middle');
  stLbl.setAttribute('font-size','16'); stLbl.setAttribute('font-weight','bold'); stLbl.setAttribute('font-family','monospace');
  stLbl.setAttribute('fill', s.state === 'q_acc' ? '#10b981' : '#93c5fd');
  stLbl.textContent = s.state; svg.appendChild(stLbl);

  // Connector lines
  for (var t = 0; t < 2; t++) {
    var ly = 38 + t * 80;
    var ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1', startX + numCells * cellW); ln.setAttribute('y1', ly);
    ln.setAttribute('x2', boxX); ln.setAttribute('y2', boxY + 35);
    ln.setAttribute('stroke', tapeColors[t]); ln.setAttribute('stroke-width', 1); ln.setAttribute('stroke-dasharray','4,3');
    svg.appendChild(ln);
  }

  document.getElementById('tm_mt_status').textContent = 'Step ' + tm_mt_stepIdx + '/' + (tm_mt_steps.length-1) + ': ' + s.msg;
  var done = (tm_mt_stepIdx >= tm_mt_steps.length - 1);
  document.getElementById('tm_mt_step_btn').disabled = done;
  document.getElementById('tm_mt_run_btn').disabled = done || tm_mt_running;
}

function tm_mt_step() {
  if (tm_mt_stepIdx < tm_mt_steps.length - 1) { tm_mt_stepIdx++; tm_mt_render(); }
}

function tm_mt_run() {
  if (tm_mt_running) return;
  tm_mt_running = true;
  function go() {
    if (tm_mt_stepIdx < tm_mt_steps.length - 1) {
      tm_mt_stepIdx++; tm_mt_render();
      tm_mt_timers.push(setTimeout(go, 500));
    } else { tm_mt_running = false; tm_mt_render(); }
  }
  go();
}

function tm_mt_reset() {
  tm_mt_running = false;
  tm_mt_timers.forEach(function(t) { clearTimeout(t); });
  tm_mt_timers = [];
  tm_mt_stepIdx = 0;
  tm_mt_render();
}

/* ============================= Enhancement 10: NTM Branching Tree (slide 15) ============================= */
var tm_ntm_timers = [];
var tm_ntm_running = false;

var tm_ntm_nodes = [
  { id:'q0', x:175, y:25, level:0, color:'#3b82f6' },
  { id:'q1', x:60,  y:85, level:1, color:'#93c5fd', parent:'q0' },
  { id:'q2', x:175, y:85, level:1, color:'#93c5fd', parent:'q0' },
  { id:'q3', x:290, y:85, level:1, color:'#93c5fd', parent:'q0' },
  { id:'q4', x:30,  y:155, level:2, color:'#ef4444', parent:'q1', status:'dead' },
  { id:'q5', x:90,  y:155, level:2, color:'#ef4444', parent:'q1', status:'dead' },
  { id:'q6', x:175, y:155, level:2, color:'#ef4444', parent:'q2', status:'dead' },
  { id:'q7', x:290, y:155, level:2, color:'#10b981', parent:'q3', status:'accept' }
];

function tm_ntm_drawNode(svg, node, visible, glow) {
  if (!visible) return;
  if (node.parent) {
    var parent = tm_ntm_nodes.find(function(n) { return n.id === node.parent; });
    var ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1', parent.x); ln.setAttribute('y1', parent.y + 16);
    ln.setAttribute('x2', node.x); ln.setAttribute('y2', node.y - 16);
    ln.setAttribute('stroke', '#475569'); ln.setAttribute('stroke-width', 1.5);
    ln.setAttribute('class', 'tm_ntm_edge_' + node.parent + '_' + node.id);
    svg.appendChild(ln);
  }
  var c = document.createElementNS('http://www.w3.org/2000/svg','circle');
  c.setAttribute('cx', node.x); c.setAttribute('cy', node.y); c.setAttribute('r', 16);
  c.setAttribute('fill', '#1e293b'); c.setAttribute('stroke', node.color); c.setAttribute('stroke-width', 2);
  if (glow) c.setAttribute('style', 'filter: drop-shadow(0 0 6px ' + node.color + ');');
  svg.appendChild(c);
  var t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x', node.x); t.setAttribute('y', node.y + 4); t.setAttribute('text-anchor','middle');
  t.setAttribute('font-size','10'); t.setAttribute('font-family','monospace'); t.setAttribute('fill', node.color); t.setAttribute('font-weight','bold');
  t.textContent = node.id; svg.appendChild(t);
  if (node.status === 'dead') {
    var x = document.createElementNS('http://www.w3.org/2000/svg','text');
    x.setAttribute('x', node.x); x.setAttribute('y', node.y + 30); x.setAttribute('text-anchor','middle');
    x.setAttribute('font-size','9'); x.setAttribute('fill','#ef4444');
    x.textContent = 'dead'; svg.appendChild(x);
  } else if (node.status === 'accept') {
    var a = document.createElementNS('http://www.w3.org/2000/svg','text');
    a.setAttribute('x', node.x); a.setAttribute('y', node.y + 30); a.setAttribute('text-anchor','middle');
    a.setAttribute('font-size','9'); a.setAttribute('fill','#10b981'); a.setAttribute('font-weight','bold');
    a.textContent = 'accept!'; svg.appendChild(a);
  }
}

function tm_ntm_render(visibleLevel, highlightPath) {
  var svg = document.getElementById('tm_ntm_svg');
  svg.innerHTML = '';
  // Draw edges first, then nodes
  for (var i = 0; i < tm_ntm_nodes.length; i++) {
    var n = tm_ntm_nodes[i];
    if (n.level <= visibleLevel) {
      tm_ntm_drawNode(svg, n, true, highlightPath && (n.id === 'q0' || n.id === 'q3' || n.id === 'q7'));
    }
  }
  // Highlight winning path
  if (highlightPath) {
    var path = [['q0','q3'],['q3','q7']];
    for (var i = 0; i < path.length; i++) {
      var parent = tm_ntm_nodes.find(function(n) { return n.id === path[i][0]; });
      var child = tm_ntm_nodes.find(function(n) { return n.id === path[i][1]; });
      var ln = document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1', parent.x); ln.setAttribute('y1', parent.y + 16);
      ln.setAttribute('x2', child.x); ln.setAttribute('y2', child.y - 16);
      ln.setAttribute('stroke', '#10b981'); ln.setAttribute('stroke-width', 3);
      svg.appendChild(ln);
    }
  }
}

function tm_ntm_run() {
  if (tm_ntm_running) return;
  tm_ntm_running = true;
  document.getElementById('tm_ntm_run_btn').disabled = true;
  tm_ntm_timers.forEach(function(t) { clearTimeout(t); });
  tm_ntm_timers = [];

  tm_ntm_render(0, false);
  tm_ntm_timers.push(setTimeout(function() { tm_ntm_render(1, false); }, 500));
  tm_ntm_timers.push(setTimeout(function() { tm_ntm_render(2, false); }, 1000));
  tm_ntm_timers.push(setTimeout(function() {
    tm_ntm_render(2, true);
    tm_ntm_running = false;
    document.getElementById('tm_ntm_run_btn').disabled = false;
  }, 1500));
}

function tm_ntm_reset() {
  tm_ntm_running = false;
  tm_ntm_timers.forEach(function(t) { clearTimeout(t); });
  tm_ntm_timers = [];
  document.getElementById('tm_ntm_run_btn').disabled = false;
  var svg = document.getElementById('tm_ntm_svg');
  svg.innerHTML = '';
  tm_ntm_render(0, false);
}

/* ============================= Enhancement 11: Classification (slide 16) ============================= */
var tm_cls_timers = [];
var tm_cls_running = false;

var tm_cls_items = [
  { name:'{ a\u207fb\u207f | n\u22650 }', type:'decidable', explain:'A TM can zig-zag matching a\'s and b\'s, always halts.' },
  { name:'{ valid C programs }', type:'decidable', explain:'Syntax checking always halts -- it\'s just parsing.' },
  { name:'Halting Problem (A_TM)', type:'re', explain:'The TM can simulate, but may never stop on non-halting inputs.' },
  { name:'Complement of A_TM', type:'not_re', explain:'If this were RE, then A_TM would be decidable (contradiction). No TM recognizes this.' },
  { name:'{ a\u207fb\u207fc\u207f }', type:'decidable', explain:'A TM can mark symbols in passes and always halt.' },
  { name:'All strings over {a,b}', type:'decidable', explain:'TM immediately accepts. Always halts.' }
];

function tm_cls_drawFlow(type) {
  var svg = document.getElementById('tm_cls_svg');
  svg.innerHTML = '';

  // Input arrow
  var inp = document.createElementNS('http://www.w3.org/2000/svg','text');
  inp.setAttribute('x', 30); inp.setAttribute('y', 42); inp.setAttribute('text-anchor','middle');
  inp.setAttribute('font-size','12'); inp.setAttribute('fill','#94a3b8'); inp.setAttribute('font-family','system-ui');
  inp.textContent = 'input'; svg.appendChild(inp);

  var arr1 = document.createElementNS('http://www.w3.org/2000/svg','line');
  arr1.setAttribute('x1', 55); arr1.setAttribute('y1', 38); arr1.setAttribute('x2', 130); arr1.setAttribute('y2', 38);
  arr1.setAttribute('stroke','#475569'); arr1.setAttribute('stroke-width', 2);
  arr1.setAttribute('marker-end','url(#tm_cls_arrowhead)'); svg.appendChild(arr1);

  // Arrowhead marker
  var defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  var marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','tm_cls_arrowhead'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','6');
  marker.setAttribute('refX','8'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  var mp = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  mp.setAttribute('points','0 0, 8 3, 0 6'); mp.setAttribute('fill','#475569');
  marker.appendChild(mp); defs.appendChild(marker); svg.appendChild(defs);

  // TM box
  var tmBox = document.createElementNS('http://www.w3.org/2000/svg','rect');
  tmBox.setAttribute('x', 135); tmBox.setAttribute('y', 15); tmBox.setAttribute('width', 100); tmBox.setAttribute('height', 50);
  tmBox.setAttribute('rx', 8); tmBox.setAttribute('fill', '#1e293b');
  tmBox.setAttribute('stroke', type === 'not_re' ? '#ef4444' : '#475569'); tmBox.setAttribute('stroke-width', 2);
  svg.appendChild(tmBox);

  var tmLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
  tmLbl.setAttribute('x', 185); tmLbl.setAttribute('y', 45); tmLbl.setAttribute('text-anchor','middle');
  tmLbl.setAttribute('font-size','14'); tmLbl.setAttribute('font-family','monospace');
  tmLbl.setAttribute('font-weight','bold');

  if (type === 'decidable') {
    tmLbl.setAttribute('fill', '#10b981');
    tmLbl.textContent = 'TM'; svg.appendChild(tmLbl);
    // YES arrow
    var arr2 = document.createElementNS('http://www.w3.org/2000/svg','line');
    arr2.setAttribute('x1', 240); arr2.setAttribute('y1', 28); arr2.setAttribute('x2', 320); arr2.setAttribute('y2', 28);
    arr2.setAttribute('stroke','#10b981'); arr2.setAttribute('stroke-width', 2); arr2.setAttribute('marker-end','url(#tm_cls_arrowhead)');
    svg.appendChild(arr2);
    var yes = document.createElementNS('http://www.w3.org/2000/svg','text');
    yes.setAttribute('x', 340); yes.setAttribute('y', 33); yes.setAttribute('font-size','16');
    yes.setAttribute('fill','#10b981'); yes.setAttribute('font-weight','bold'); yes.textContent = 'YES';
    svg.appendChild(yes);
    // NO arrow
    var arr3 = document.createElementNS('http://www.w3.org/2000/svg','line');
    arr3.setAttribute('x1', 240); arr3.setAttribute('y1', 50); arr3.setAttribute('x2', 320); arr3.setAttribute('y2', 50);
    arr3.setAttribute('stroke','#10b981'); arr3.setAttribute('stroke-width', 2); arr3.setAttribute('marker-end','url(#tm_cls_arrowhead)');
    svg.appendChild(arr3);
    var no = document.createElementNS('http://www.w3.org/2000/svg','text');
    no.setAttribute('x', 340); no.setAttribute('y', 55); no.setAttribute('font-size','16');
    no.setAttribute('fill','#10b981'); no.setAttribute('font-weight','bold'); no.textContent = 'NO';
    svg.appendChild(no);
    var hlbl = document.createElementNS('http://www.w3.org/2000/svg','text');
    hlbl.setAttribute('x', 420); hlbl.setAttribute('y', 42); hlbl.setAttribute('font-size','11');
    hlbl.setAttribute('fill','#94a3b8'); hlbl.textContent = '(always halts)'; svg.appendChild(hlbl);
  } else if (type === 're') {
    tmLbl.setAttribute('fill', '#f59e0b');
    tmLbl.textContent = 'TM'; svg.appendChild(tmLbl);
    // YES arrow
    var arr2 = document.createElementNS('http://www.w3.org/2000/svg','line');
    arr2.setAttribute('x1', 240); arr2.setAttribute('y1', 28); arr2.setAttribute('x2', 320); arr2.setAttribute('y2', 28);
    arr2.setAttribute('stroke','#10b981'); arr2.setAttribute('stroke-width', 2); arr2.setAttribute('marker-end','url(#tm_cls_arrowhead)');
    svg.appendChild(arr2);
    var yes = document.createElementNS('http://www.w3.org/2000/svg','text');
    yes.setAttribute('x', 340); yes.setAttribute('y', 33); yes.setAttribute('font-size','16');
    yes.setAttribute('fill','#10b981'); yes.setAttribute('font-weight','bold'); yes.textContent = 'YES';
    svg.appendChild(yes);
    // LOOP arrow
    var arr3 = document.createElementNS('http://www.w3.org/2000/svg','line');
    arr3.setAttribute('x1', 240); arr3.setAttribute('y1', 50); arr3.setAttribute('x2', 320); arr3.setAttribute('y2', 50);
    arr3.setAttribute('stroke','#f59e0b'); arr3.setAttribute('stroke-width', 2); arr3.setAttribute('stroke-dasharray','4,3');
    svg.appendChild(arr3);
    var loop = document.createElementNS('http://www.w3.org/2000/svg','text');
    loop.setAttribute('x', 340); loop.setAttribute('y', 55); loop.setAttribute('font-size','14');
    loop.setAttribute('fill','#f59e0b'); loop.setAttribute('font-weight','bold'); loop.textContent = 'LOOP...';
    loop.setAttribute('style','animation: tm_venn_pulse 1s infinite');
    svg.appendChild(loop);
  } else {
    tmLbl.setAttribute('fill', '#ef4444');
    tmLbl.textContent = '???'; svg.appendChild(tmLbl);
    var xmark = document.createElementNS('http://www.w3.org/2000/svg','text');
    xmark.setAttribute('x', 290); xmark.setAttribute('y', 45); xmark.setAttribute('font-size','28');
    xmark.setAttribute('fill','#ef4444'); xmark.setAttribute('font-weight','bold'); xmark.textContent = '\u2717';
    svg.appendChild(xmark);
    var noTM = document.createElementNS('http://www.w3.org/2000/svg','text');
    noTM.setAttribute('x', 340); noTM.setAttribute('y', 42); noTM.setAttribute('font-size','11');
    noTM.setAttribute('fill','#ef4444'); noTM.textContent = 'No TM exists'; svg.appendChild(noTM);
  }
}

function tm_cls_show(idx) {
  if (tm_cls_running) return;
  tm_cls_running = true;
  tm_cls_timers.forEach(function(t) { clearTimeout(t); });
  tm_cls_timers = [];

  var btns = document.querySelectorAll('.tm_cls-buttons button');
  btns.forEach(function(b) { b.classList.remove('active'); });
  btns[idx].classList.add('active');

  var item = tm_cls_items[idx];
  var result = document.getElementById('tm_cls_result');
  result.innerHTML = 'Classifying...';

  // Clear SVG
  document.getElementById('tm_cls_svg').innerHTML = '';

  tm_cls_timers.push(setTimeout(function() {
    tm_cls_drawFlow(item.type);
    var typeLabel = item.type === 'decidable' ? '<span style="color:#10b981;font-weight:bold;">Decidable</span>' :
                    item.type === 're' ? '<span style="color:#f59e0b;font-weight:bold;">RE but NOT Decidable</span>' :
                    '<span style="color:#ef4444;font-weight:bold;">Not even RE</span>';
    result.innerHTML = typeLabel + ' -- ' + item.explain;
    tm_cls_running = false;
  }, 400));
}

/* ============================= Enhancement 12: Venn Diagram (slide 19) ============================= */
var tm_venn_timers = [];
var tm_venn_animating = false;

var tm_venn_regions = {
  recursive: { x: 100, y: 155, cx: 200, cy: 200 },
  re: { x: 85, y: 105, cx: 200, cy: 175 },
  all: { x: 40, y: 50, cx: 200, cy: 135 }
};

var tm_venn_examples = [
  { label:'a*b*', region:'recursive', color:'#10b981', explain:'Regular -- also decidable.' },
  { label:'a\u207fb\u207fc\u207f', region:'recursive', color:'#10b981', explain:'Decidable by zig-zag TM.' },
  { label:'Halting Problem', region:'re', color:'#3b82f6', explain:'RE but not decidable.' },
  { label:'Complement of HP', region:'all', color:'#64748b', explain:'Not even recognizable.' },
  { label:'Every CFL', region:'recursive', color:'#10b981', explain:'All context-free languages are decidable.' },
  { label:'{ww}', region:'recursive', color:'#10b981', explain:'Decidable -- TM can compare halves.' }
];

function tm_venn_drawBase() {
  var svg = document.getElementById('tm_venn_svg');
  svg.innerHTML = '';

  // Outermost: ALL LANGUAGES
  var r1 = document.createElementNS('http://www.w3.org/2000/svg','rect');
  r1.setAttribute('x', 20); r1.setAttribute('y', 20); r1.setAttribute('width', 360); r1.setAttribute('height', 280);
  r1.setAttribute('rx', 16); r1.setAttribute('fill', 'rgba(71,85,105,0.08)'); r1.setAttribute('stroke', '#475569'); r1.setAttribute('stroke-width', 2);
  svg.appendChild(r1);
  var l1 = document.createElementNS('http://www.w3.org/2000/svg','text');
  l1.setAttribute('x', 200); l1.setAttribute('y', 42); l1.setAttribute('text-anchor','middle');
  l1.setAttribute('font-size','11'); l1.setAttribute('fill','#64748b'); l1.setAttribute('font-family','system-ui');
  l1.textContent = 'ALL LANGUAGES'; svg.appendChild(l1);

  // Middle: RE
  var r2 = document.createElementNS('http://www.w3.org/2000/svg','rect');
  r2.setAttribute('x', 50); r2.setAttribute('y', 60); r2.setAttribute('width', 300); r2.setAttribute('height', 220);
  r2.setAttribute('rx', 12); r2.setAttribute('fill', 'rgba(59,130,246,0.06)'); r2.setAttribute('stroke', '#3b82f6'); r2.setAttribute('stroke-width', 2);
  svg.appendChild(r2);
  var l2 = document.createElementNS('http://www.w3.org/2000/svg','text');
  l2.setAttribute('x', 200); l2.setAttribute('y', 80); l2.setAttribute('text-anchor','middle');
  l2.setAttribute('font-size','11'); l2.setAttribute('fill','#3b82f6'); l2.setAttribute('font-family','system-ui');
  l2.textContent = 'Recursively Enumerable (RE)'; svg.appendChild(l2);

  // Innermost: Recursive (Decidable)
  var r3 = document.createElementNS('http://www.w3.org/2000/svg','rect');
  r3.setAttribute('x', 80); r3.setAttribute('y', 110); r3.setAttribute('width', 240); r3.setAttribute('height', 150);
  r3.setAttribute('rx', 10); r3.setAttribute('fill', 'rgba(16,185,129,0.06)'); r3.setAttribute('stroke', '#10b981'); r3.setAttribute('stroke-width', 2);
  svg.appendChild(r3);
  var l3 = document.createElementNS('http://www.w3.org/2000/svg','text');
  l3.setAttribute('x', 200); l3.setAttribute('y', 130); l3.setAttribute('text-anchor','middle');
  l3.setAttribute('font-size','11'); l3.setAttribute('fill','#10b981'); l3.setAttribute('font-family','system-ui');
  l3.textContent = 'Recursive (Decidable)'; svg.appendChild(l3);

  // Region labels
  var notRE = document.createElementNS('http://www.w3.org/2000/svg','text');
  notRE.setAttribute('x', 350); notRE.setAttribute('y', 52); notRE.setAttribute('text-anchor','end');
  notRE.setAttribute('font-size','9'); notRE.setAttribute('fill','#475569'); notRE.setAttribute('font-style','italic');
  notRE.textContent = 'not even RE here'; svg.appendChild(notRE);

  var reOnly = document.createElementNS('http://www.w3.org/2000/svg','text');
  reOnly.setAttribute('x', 310); reOnly.setAttribute('y', 268); reOnly.setAttribute('text-anchor','middle');
  reOnly.setAttribute('font-size','9'); reOnly.setAttribute('fill','#3b82f6'); reOnly.setAttribute('font-style','italic');
  reOnly.textContent = 'RE but not decidable'; svg.appendChild(reOnly);
}

function tm_venn_fly(idx) {
  if (tm_venn_animating) return;
  tm_venn_animating = true;
  tm_venn_timers.forEach(function(t) { clearTimeout(t); });
  tm_venn_timers = [];

  tm_venn_drawBase();
  var ex = tm_venn_examples[idx];
  var svg = document.getElementById('tm_venn_svg');
  var msg = document.getElementById('tm_venn_msg');
  msg.innerHTML = '';

  // Target coordinates based on region
  var targets = {
    recursive: { x: 200, y: 190 },
    re: { x: 200, y: 255 },
    all: { x: 200, y: 305 }
  };
  var target = targets[ex.region];

  // Create animated dot
  var dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx', 0); dot.setAttribute('cy', 320); dot.setAttribute('r', 6);
  dot.setAttribute('fill', ex.color); dot.setAttribute('opacity', '0.9');
  svg.appendChild(dot);

  var label = document.createElementNS('http://www.w3.org/2000/svg','text');
  label.setAttribute('x', 0); label.setAttribute('y', 316); label.setAttribute('text-anchor','middle');
  label.setAttribute('font-size','10'); label.setAttribute('fill', ex.color); label.setAttribute('font-family','monospace');
  label.textContent = ex.label; svg.appendChild(label);

  // Animate in 20 frames over 600ms
  var frames = 20;
  var startX = 0, startY = 320;
  for (var f = 0; f <= frames; f++) {
    (function(frame) {
      tm_venn_timers.push(setTimeout(function() {
        var t = frame / frames;
        var cx = startX + (target.x - startX) * t;
        var cy = startY + (target.y - startY) * t;
        dot.setAttribute('cx', cx); dot.setAttribute('cy', cy);
        label.setAttribute('x', cx); label.setAttribute('y', cy - 12);
        if (frame === frames) {
          // Flash effect
          dot.setAttribute('r', '10'); dot.setAttribute('opacity', '1');
          tm_venn_timers.push(setTimeout(function() {
            dot.setAttribute('r', '6'); dot.setAttribute('opacity', '0.8');
            msg.innerHTML = '<span style="color:' + ex.color + ';">' + ex.explain + '</span>';
            tm_venn_animating = false;
          }, 200));
        }
      }, frame * 30));
    })(f);
  }
}

/* ============================= Init on load ============================= */
tm_mach_render();
tm_trx_init();
tm_q1_init();
tm_cmp_init();
tm_id_init();
tm_mt_render();
tm_ntm_render(0, false);
tm_venn_drawBase();

// Hero animated tape (slide 1)
(function() {
  var tape = ['B','1','0','1','1','0','1','B','B','B','B'];
  var states = ['q\u2080','q\u2081','q\u2082','q\u2083','q\u2084'];
  var headPos = 1;
  var stateIdx = 0;
  var cellW = 55, cellH = 40, startX = 27, startY = 20;
  var numCells = 11;
  var heroTimer = null;
  var writes = ['X','Y','X','Y','X','Y','1','0','1','1','0'];

  function render() {
    var g = document.getElementById('tm_hero_tape');
    if (!g) return;
    g.innerHTML = '';
    for (var i = 0; i < numCells; i++) {
      var x = startX + i * cellW;
      var isHead = (i === headPos);
      var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', x); r.setAttribute('y', startY);
      r.setAttribute('width', cellW); r.setAttribute('height', cellH);
      r.setAttribute('rx', '6');
      r.setAttribute('fill', isHead ? 'rgba(251,191,36,0.12)' : '#1e293b');
      r.setAttribute('stroke', isHead ? '#fbbf24' : '#475569');
      r.setAttribute('stroke-width', isHead ? '2' : '1');
      g.appendChild(r);
      var t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x + cellW/2); t.setAttribute('y', startY + cellH/2 + 5);
      t.setAttribute('text-anchor', 'middle');
      t.setAttribute('font-family', 'monospace'); t.setAttribute('font-size', '16');
      t.setAttribute('font-weight', 'bold');
      var sym = tape[i];
      t.setAttribute('fill', sym === 'B' ? '#475569' : sym === 'X' ? '#67e8f9' : sym === 'Y' ? '#c4b5fd' : '#e2e8f0');
      t.textContent = sym;
      g.appendChild(t);
    }
    // ellipsis
    var ldots = document.createElementNS('http://www.w3.org/2000/svg','text');
    ldots.setAttribute('x', startX - 10); ldots.setAttribute('y', startY + cellH/2 + 5);
    ldots.setAttribute('text-anchor', 'end'); ldots.setAttribute('fill', '#475569');
    ldots.setAttribute('font-size', '14'); ldots.setAttribute('font-family', 'monospace');
    ldots.textContent = '...'; g.appendChild(ldots);
    var rdots = document.createElementNS('http://www.w3.org/2000/svg','text');
    rdots.setAttribute('x', startX + numCells * cellW + 10); rdots.setAttribute('y', startY + cellH/2 + 5);
    rdots.setAttribute('text-anchor', 'start'); rdots.setAttribute('fill', '#475569');
    rdots.setAttribute('font-size', '14'); rdots.setAttribute('font-family', 'monospace');
    rdots.textContent = '...'; g.appendChild(rdots);
    // head position
    var hx = startX + headPos * cellW + cellW/2;
    document.getElementById('tm_hero_head').setAttribute('points',
      hx+',95 '+(hx-10)+',110 '+(hx+10)+',110');
    document.getElementById('tm_hero_state').textContent = states[stateIdx];
  }

  function tick() {
    // Write a symbol
    tape[headPos] = writes[headPos] || tape[headPos];
    // Move right, wrap around non-blank region
    headPos++;
    if (headPos >= numCells - 2) {
      // Reset for continuous loop
      headPos = 1;
      tape = ['B','1','0','1','1','0','1','B','B','B','B'];
    }
    stateIdx = (stateIdx + 1) % states.length;
    render();
  }

  function startAnim() {
    if (heroTimer) return;
    heroTimer = setInterval(tick, 900);
  }
  function stopAnim() {
    if (heroTimer) { clearInterval(heroTimer); heroTimer = null; }
  }

  // Run when slide 1 is active, stop otherwise
  var obs = new MutationObserver(function() {
    var s1 = document.getElementById('s1');
    if (s1 && s1.classList.contains('active')) { render(); startAnim(); }
    else { stopAnim(); }
  });
  var s1el = document.getElementById('s1');
  if (s1el) {
    obs.observe(s1el, {attributes: true, attributeFilter: ['class']});
    if (s1el.classList.contains('active')) { render(); startAnim(); }
  }
})();

showSlide(1);
</script>

</body>
</html>
